#!/usr/bin/env python3
"""
Thread Caption Generator v1.1
Â§2.9 ì“°ë ˆë“œ ìº¡ì…˜ í‘œì¤€ì— ë”°ë¥¸ ìº¡ì…˜ ìƒì„±
"""

import os
import sys
import json
from pathlib import Path

BASE_PATH = "/Users/al02399300/Desktop/Jun_AI/Dog_Contents/project_sunshine"

# ìŒì‹ë³„ ì´ëª¨ì§€ ë§¤í•‘ (í™•ì¥)
FOOD_EMOJI = {
    "í˜¸ë°•": "ğŸƒ", "ë‹¹ê·¼": "ğŸ¥•", "ë¸”ë£¨ë² ë¦¬": "ğŸ«", "ì²´ë¦¬": "ğŸ’",
    "ê³ êµ¬ë§ˆ": "ğŸ ", "ì‚¬ê³¼": "ğŸ", "íŒŒì¸ì• í”Œ": "ğŸ", "ë°”ë‚˜ë‚˜": "ğŸŒ",
    "ë¸Œë¡œì½œë¦¬": "ğŸ¥¦", "ìˆ˜ë°•": "ğŸ‰", "ë”¸ê¸°": "ğŸ“", "ë§ê³ ": "ğŸ¥­",
    "ì˜¤ë Œì§€": "ğŸŠ", "ë°°": "ğŸ", "í‚¤ìœ„": "ğŸ¥", "íŒŒíŒŒì•¼": "ğŸˆ",
    "ë³µìˆ­ì•„": "ğŸ‘", "í°ìŒ€ë°¥": "ğŸš", "ì˜¤ì´": "ğŸ¥’", "í”„ë§ê¸€ìŠ¤": "ğŸŸ",
    "ì†Œì‹œì§€": "ğŸŒ­", "ì•„ë³´ì¹´ë„": "ğŸ¥‘", "ì½œë¼": "ğŸ¥¤", "ì˜¬ë¦¬ë¸Œ": "ğŸ«’",
    "ë¸”ë™ë² ë¦¬": "ğŸ«", "ì‹œê¸ˆì¹˜": "ğŸ¥¬", "ì• í˜¸ë°•": "ğŸ¥’", "ë‹­ê³ ê¸°": "ğŸ—",
    "ìˆ˜ë€": "ğŸ¥š", "ê²¬ê³¼ë¥˜": "ğŸ¥œ", "ì‚¶ì€ë‹¬ê±€": "ğŸ¥š", "ìš°ìœ ": "ğŸ¥›",
    "ë°”ê²ŒíŠ¸": "ğŸ¥–", "ë‹¨íŒ¥ë¹µ": "ğŸ", "ê°ì": "ğŸ¥”", "ì†Œê³ ê¸°": "ğŸ¥©",
    "ì½œë¦¬í”Œë¼ì›Œ": "ğŸ¥¦", "ìˆ™ì£¼ë‚˜ë¬¼": "ğŸŒ±", "ìš”ê±°íŠ¸": "ğŸ¥›", "ì—°ê·¼": "ğŸŒ¸",
    "ìš°ì—‰": "ğŸŒ¿", "ì˜¤íŠ¸ë°€": "ğŸ¥£", "ë©œë¡ ": "ğŸˆ", "ì•„ëª¬ë“œ": "ğŸŒ°",
    "ë‹¬ê±€ë…¸ë¥¸ì": "ğŸ¥š", "ì„ë¥˜": "ğŸ", "ê³ ë“±ì–´": "ğŸŸ", "ë‘ë¶€": "ğŸ§ˆ",
    "ì—°ì–´": "ğŸ£", "ìë‘": "ğŸ‘", "ë‹¨í˜¸ë°•": "ğŸƒ", "í¬ë„": "ğŸ‡",
    "ê±´í¬ë„": "ğŸ‡", "ì´ˆì½œë¦¿": "ğŸ«", "ê¹€ì¹˜": "ğŸ¥¬", "ë©”ì¶”ë¦¬ì•Œ": "ğŸ¥š",
    "ì–‘ë…ì¹˜í‚¨": "ğŸ—", "ë–¡êµ­": "ğŸœ", "ë¶ì–´": "ğŸŸ", "ê¹€ë°¥": "ğŸ™",
    "ë¹„ë¹”ë°¥": "ğŸš", "ìš°ë™": "ğŸœ", "ë¼ë©´": "ğŸœ", "ì‚¼ê²¹ì‚´": "ğŸ¥“",
    "ë¶ˆê³ ê¸°": "ğŸ–", "ì¼€ì´í¬": "ğŸ‚", "ì•„ì´ìŠ¤í¬ë¦¼": "ğŸ¦", "ë¸Œë¼ìš°ë‹ˆ": "ğŸ«",
    "ë¨¸í•€": "ğŸ§", "íŒ¬ì¼€ì´í¬": "ğŸ¥", "ì™€í”Œ": "ğŸ§‡", "ì‹œë¦¬ì–¼": "ğŸ¥£",
    "ê·¸ë˜ë†€ë¼": "ğŸ¥£", "ë‹­ê°•ì •": "ğŸ—", "ë¯¸íŠ¸ë³¼": "ğŸ–", "ë² ì´ì»¨": "ğŸ¥“",
    "ë²„ë“œì™€ì´ì €": "ğŸº", "ì¹´ìŠ¤": "ğŸº", "í¬ë£¨ì•„ìƒ": "ğŸ¥", "ë„ë¦¬í† ìŠ¤": "ğŸŒ®",
    "í‚·ìº£": "ğŸ«", "ë ˆì´ì¦ˆ": "ğŸ¥”", "í˜ë¦¬ì—": "ğŸ’§", "í”¼ì": "ğŸ•",
    "ë¦¬ì„¸ìŠ¤": "ğŸ«", "ë¦¬ì¸ ": "ğŸª", "ìŠ¤í‚¤í‹€ì¦ˆ": "ğŸ¬", "ì†Œì£¼": "ğŸ¶",
    "ìŠ¤íƒ€ë²…ìŠ¤ì»¤í”¼": "â˜•", "ìŠ¤íƒ€ë²„ìŠ¤íŠ¸": "ğŸ¬", "í°ì‚´ìƒì„ ": "ğŸŸ",
    "ìŠ¤í”„ë¼ì´íŠ¸": "ğŸ¥¤", "ë‹­ê°€ìŠ´ì‚´": "ğŸ—", "ìƒˆìš°": "ğŸ¦", "ì‚°ë”¸ê¸°": "ğŸ“",
    "ì½”ì½”ë„›": "ğŸ¥¥", "ìëª½": "ğŸŠ", "ë ˆëª¬": "ğŸ‹", "ì–‘ë°°ì¶”": "ğŸ¥¬",
    "ì•„ìŠ¤íŒŒë¼ê±°ìŠ¤": "ğŸŒ¿", "ë¹„íŠ¸": "ğŸ¥—", "ë°°ì¶”": "ğŸ¥¬", "ìƒì¶”": "ğŸ¥¬",
    "ì°¸ì¹˜": "ğŸŸ", "ìƒëŸ¬ë¦¬": "ğŸŒ¿", "ê¹ì§€ì½©": "ğŸ«›", "ë–¡": "ğŸ¡",
    "ì™„ë‘ì½©": "ğŸ«›", "í™©íƒœ": "ğŸŸ", "ëŒ€íŒŒ": "ğŸ§…", "ì˜¤ì§•ì–´": "ğŸ¦‘",
    "ë©¸ì¹˜": "ğŸŸ", "ê¹€": "ğŸŒ¿", "ëª…íƒœ": "ğŸŸ", "ì¼€ì¼": "ğŸ¥¬",
    "íŒŒìŠ¤íƒ€": "ğŸ", "ì‹ë¹µ": "ğŸ", "ì½”ì½”ë„›ì˜¤ì¼": "ğŸ¥¥", "ì°¸ì™¸": "ğŸˆ",
    "ì¹˜ì¦ˆ": "ğŸ§€"
}

# FORBIDDEN ìŒì‹ ë…ì„± ì •ë³´
FORBIDDEN_INFO = {
    "í”„ë§ê¸€ìŠ¤": {"ë…ì„±": "ì–‘ë…/ì†Œê¸ˆ/í™”í•™ì²¨ê°€ë¬¼ì´ ê°•ì•„ì§€ì—ê²Œ í•´ë¡œì›Œìš”", "ìœ„í—˜ëŸ‰": "ì†ŒëŸ‰"},
    "ì•„ë³´ì¹´ë„": {"ë…ì„±": "í¼ì‹  ì„±ë¶„ì´ êµ¬í† /ì„¤ì‚¬ë¥¼ ì¼ìœ¼ì¼œìš”", "ìœ„í—˜ëŸ‰": "ì¡°ê¸ˆë§Œ"},
    "ì½œë¼": {"ë…ì„±": "ì¹´í˜ì¸ê³¼ ë‹¹ë¶„ì´ ì‹¬ì¥ì— ë¬´ë¦¬ë¥¼ ì¤˜ìš”", "ìœ„í—˜ëŸ‰": "í•œ ëª¨ê¸ˆ"},
    "ìš°ìœ ": {"ë…ì„±": "ìœ ë‹¹ë¶ˆë‚´ì¦ìœ¼ë¡œ ì„¤ì‚¬ë¥¼ ì¼ìœ¼ì¼œìš”", "ìœ„í—˜ëŸ‰": "ì¡°ê¸ˆ"},
    "ì´ˆì½œë¦¿": {"ë…ì„±": "í…Œì˜¤ë¸Œë¡œë¯¼ì´ ì‹¬ì¥/ì‹ ê²½ê³„ì— ì¹˜ëª…ì ì´ì—ìš”", "ìœ„í—˜ëŸ‰": "ì†ŒëŸ‰"},
    "í¬ë„": {"ë…ì„±": "ì‹ ë¶€ì „ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆì–´ìš”", "ìœ„í—˜ëŸ‰": "ëª‡ ì•Œ"},
    "ê±´í¬ë„": {"ë…ì„±": "ì‹ ë¶€ì „ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆì–´ìš”", "ìœ„í—˜ëŸ‰": "ëª‡ ì•Œ"},
    "ì–‘ë…ì¹˜í‚¨": {"ë…ì„±": "ì–‘ë…/ì†Œê¸ˆ/ë§ˆëŠ˜ì´ ê°•ì•„ì§€ì—ê²Œ í•´ë¡œì›Œìš”", "ìœ„í—˜ëŸ‰": "ì¡°ê¸ˆ"},
    "ë²„ë“œì™€ì´ì €": {"ë…ì„±": "ì•Œì½”ì˜¬ì€ ê°•ì•„ì§€ì—ê²Œ ë…ì´ì—ìš”", "ìœ„í—˜ëŸ‰": "í•œ ëª¨ê¸ˆë„"},
    "ì¹´ìŠ¤": {"ë…ì„±": "ì•Œì½”ì˜¬ì€ ê°•ì•„ì§€ì—ê²Œ ë…ì´ì—ìš”", "ìœ„í—˜ëŸ‰": "í•œ ëª¨ê¸ˆë„"},
    "ì†Œì£¼": {"ë…ì„±": "ì•Œì½”ì˜¬ì€ ê°•ì•„ì§€ì—ê²Œ ë…ì´ì—ìš”", "ìœ„í—˜ëŸ‰": "í•œ ë°©ìš¸ë„"},
    "ì•„ì´ìŠ¤í¬ë¦¼": {"ë…ì„±": "ìœ ë‹¹/ë‹¹ë¶„/ì²¨ê°€ë¬¼ì´ ì†Œí™”ì— í•´ë¡œì›Œìš”", "ìœ„í—˜ëŸ‰": "ì¡°ê¸ˆ"},
}


def generate_safe_caption(food_name, info):
    """SAFE í…œí”Œë¦¿ ìº¡ì…˜ ìƒì„±"""
    emoji = FOOD_EMOJI.get(food_name, "ğŸ•")

    # food_dataì—ì„œ ì˜ì–‘ì†Œ ì¶”ì¶œ
    nutrients = info.get("nutrients", [])
    if len(nutrients) >= 2:
        íš¨ëŠ¥1 = nutrients[0].get("benefit", "ì˜ì–‘")
        íš¨ëŠ¥2 = nutrients[1].get("benefit", "ê±´ê°•")
    else:
        íš¨ëŠ¥1 = "ì˜ì–‘"
        íš¨ëŠ¥2 = "ê±´ê°•"

    caption = f"""{food_name} ê°•ì•„ì§€í•œí…Œ ì¤˜ë„ ë˜ë‚˜ìš”? {emoji}
ìš°ë¦¬ í–‡ì‚´ì´ {food_name} ì™„ì „ ì¢‹ì•„í•´ìš”!

{food_name}ì€ ê°•ì•„ì§€í•œí…Œ ì •ë§ ì¢‹ì€ ê°„ì‹ì´ì—ìš”.
{íš¨ëŠ¥1}ë„ ì¢‹ê³  {íš¨ëŠ¥2}ì—ë„ ì¢‹ì•„ìš”.
ê°„ì‹ìœ¼ë¡œ ë§˜ê» ì¤˜ë„ ë¼ìš”~ ğŸ•

ì—¬ëŸ¬ë¶„ ê°•ì•„ì§€ë„ {food_name} ì¢‹ì•„í•˜ë‚˜ìš”?
â„¹ï¸ ì¼ë¶€ ì´ë¯¸ì§€ëŠ” AIë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"""

    return caption


def generate_caution_caption(food_name, info):
    """CAUTION í…œí”Œë¦¿ ìº¡ì…˜ ìƒì„±"""
    emoji = FOOD_EMOJI.get(food_name, "ğŸ•")

    # do/dontì—ì„œ ì¡°ê±´ ì¶”ì¶œ
    do_items = info.get("do_items", ["ì†ŒëŸ‰ë§Œ ê¸‰ì—¬"])
    dont_items = info.get("dont_items", ["ê³¼ë‹¤ ê¸‰ì—¬ ê¸ˆì§€"])
    nutrients = info.get("nutrients", [])

    íš¨ëŠ¥ = nutrients[0].get("benefit", "ì˜ì–‘") if nutrients else "ì˜ì–‘"
    ì¡°ê±´1 = do_items[0].replace("í•˜ì„¸ìš”", "") if do_items else "ì†ŒëŸ‰ë§Œ"
    ì¡°ê±´2 = do_items[1].replace("í•˜ì„¸ìš”", "") if len(do_items) > 1 else "ìµí˜€ì„œ"
    ê¸ˆì§€ = dont_items[0].replace("ì˜ˆìš”", "") if dont_items else "ê³¼ë‹¤ ê¸‰ì—¬ ê¸ˆì§€"

    caption = f"""{food_name} ê°•ì•„ì§€í•œí…Œ ì¤˜ë„ ë ê¹Œìš”? {emoji}
ìš°ë¦¬ í–‡ì‚´ì´ëŠ” {food_name} ì¢‹ì•„í•´ìš”!

{íš¨ëŠ¥} ì¢‹ì§€ë§Œ, ì¡°ê±´ì´ ìˆì–´ìš”!
âœ”ï¸ {ì¡°ê±´1} âœ”ï¸ {ì¡°ê±´2} âŒ {ê¸ˆì§€}

ì—¬ëŸ¬ë¶„ ê°•ì•„ì§€ëŠ” {food_name} ì¢‹ì•„í•˜ë‚˜ìš”? ğŸ•
â„¹ï¸ ì¼ë¶€ ì´ë¯¸ì§€ëŠ” AIë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"""

    return caption


def generate_forbidden_caption(food_name, info):
    """FORBIDDEN í…œí”Œë¦¿ ìº¡ì…˜ ìƒì„±"""
    emoji = FOOD_EMOJI.get(food_name, "ğŸš«")

    forbidden = FORBIDDEN_INFO.get(food_name, {
        "ë…ì„±": "ê°•ì•„ì§€ì—ê²Œ í•´ë¡œìš¸ ìˆ˜ ìˆì–´ìš”",
        "ìœ„í—˜ëŸ‰": "ì†ŒëŸ‰"
    })

    ë…ì„± = forbidden["ë…ì„±"]
    ìœ„í—˜ëŸ‰ = forbidden["ìœ„í—˜ëŸ‰"]

    caption = f"""{food_name} ê°•ì•„ì§€í•œí…Œ ì ˆëŒ€ ì£¼ë©´ ì•ˆ ë¼ìš”! {emoji}
ìš°ë¦¬ í–‡ì‚´ì´ë„ ì ˆëŒ€ ì•ˆ ì¤˜ìš”!

{ë…ì„±} {ìœ„í—˜ëŸ‰}ë§Œ ë¨¹ì–´ë„ ìœ„í—˜í•´ìš”.
ğŸš¨ ë¨¹ì—ˆë‹¤ë©´ â†’ ì¦‰ì‹œ ë™ë¬¼ë³‘ì›! (ë¨¹ì€ ì–‘/ì‹œê°„ ê¸°ì–µ)

ëª¨ë¥´ê³  ì£¼ì‹œëŠ” ë¶„ë“¤ ë§ì•„ì„œ ê³µìœ í•´ìš”.
â„¹ï¸ ì¼ë¶€ ì´ë¯¸ì§€ëŠ” AIë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"""

    return caption


def get_folder_path(content_id):
    """ì½˜í…ì¸  í´ë” ê²½ë¡œ ì°¾ê¸° (í”Œë« êµ¬ì¡°)"""
    # 2026-02-13: í”Œë« êµ¬ì¡° - STATUS_DIRS ì œê±°
    # content_dirs = [
    #     os.path.join(BASE_PATH, "contents", "4_posted"),
    #     os.path.join(BASE_PATH, "contents", "3_approved"),
    #     os.path.join(BASE_PATH, "contents", "2_body_ready"),
    #     os.path.join(BASE_PATH, "contents", "1_cover_only"),
    # ]

    contents_dir = os.path.join(BASE_PATH, "contents")
    if not os.path.exists(contents_dir):
        return None
    for folder in os.listdir(contents_dir):
        if folder.startswith(f"{content_id:03d}_"):
            return os.path.join(contents_dir, folder)

    return None


def main():
    # ë²”ìœ„ íŒŒì‹±
    if len(sys.argv) > 1:
        arg = sys.argv[1]
        if "-" in arg:
            start, end = map(int, arg.split("-"))
        else:
            start = end = int(arg)
    else:
        start, end = 1, 50  # ê¸°ë³¸ ë²”ìœ„

    print("="*50)
    print("Thread Caption Generator v1.1")
    print(f"Â§2.9 ì“°ë ˆë“œ ìº¡ì…˜ í‘œì¤€ ì ìš© ({start}~{end}ë²ˆ)")
    print("="*50)
    print()

    # food_data.json ë¡œë“œ
    with open(os.path.join(BASE_PATH, "config", "food_data.json"), 'r', encoding='utf-8') as f:
        food_data = json.load(f)

    generated = 0
    skipped = 0
    results = {"SAFE": 0, "CAUTION": 0, "FORBIDDEN": 0}

    for i in range(start, end + 1):
        info = food_data.get(str(i), {})
        food_name = info.get("name", "")
        safety = info.get("safety", "SAFE")

        if not food_name:
            print(f"âŒ {i:02d}: ë°ì´í„° ì—†ìŒ")
            skipped += 1
            continue

        # í´ë” ì°¾ê¸°
        folder_path = get_folder_path(i)
        if not folder_path:
            print(f"âš ï¸ {i:02d}. {food_name}: í´ë” ì—†ìŒ (ìŠ¤í‚µ)")
            skipped += 1
            continue

        # 01_Insta&Thread í´ë” ìƒì„±
        thread_dir = os.path.join(folder_path, "01_Insta&Thread")
        os.makedirs(thread_dir, exist_ok=True)

        caption_path = os.path.join(thread_dir, "caption.txt")

        # ìº¡ì…˜ ìƒì„±
        if safety == "SAFE":
            caption = generate_safe_caption(food_name, info)
        elif safety == "CAUTION":
            caption = generate_caution_caption(food_name, info)
        elif safety == "FORBIDDEN":
            caption = generate_forbidden_caption(food_name, info)
        else:
            print(f"âš ï¸ {i:02d}. {food_name}: ì§€ì›í•˜ì§€ ì•ŠëŠ” ì•ˆì „ë„ ({safety})")
            skipped += 1
            continue

        # ì €ì¥
        with open(caption_path, 'w', encoding='utf-8') as f:
            f.write(caption)

        print(f"âœ… {i:02d}. {food_name} [{safety}]")
        generated += 1
        results[safety] = results.get(safety, 0) + 1

    print()
    print("="*50)
    print(f"ì™„ë£Œ: {generated}ê°œ ìƒì„± / {skipped}ê°œ ìŠ¤í‚µ")
    print(f"  SAFE: {results.get('SAFE', 0)}ê°œ")
    print(f"  CAUTION: {results.get('CAUTION', 0)}ê°œ")
    print(f"  FORBIDDEN: {results.get('FORBIDDEN', 0)}ê°œ")
    print("="*50)


if __name__ == "__main__":
    main()
