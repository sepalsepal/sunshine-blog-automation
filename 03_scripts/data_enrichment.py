#!/usr/bin/env python3
"""
ğŸ“Š ë°ì´í„° ë³´ê°• ìŠ¤í¬ë¦½íŠ¸ (ì—…ë¬´ 23-27ë²ˆ)

23. food_safety.json ëˆ„ë½ í•­ëª© ì¶”ê°€
24. í•œê¸€ëª… ëˆ„ë½ ë³´ê°•
25. í•´ì‹œíƒœê·¸ ë°ì´í„° ìƒì„± (ìŠ¤í‚µ - ìˆ˜ë™ í•„ìš”)
26. ìº¡ì…˜ í…œí”Œë¦¿ ìƒì„±
27. posting_schedule.json ìƒì„±
"""

import json
from pathlib import Path
from datetime import datetime, timedelta

PROJECT_ROOT = Path(__file__).parent.parent
CONTENTS_DIR = PROJECT_ROOT / "01_contents"
CONFIG_DIR = PROJECT_ROOT / "config"
SETTINGS_DIR = CONFIG_DIR / "settings"


def check_food_safety():
    """23ë²ˆ: food_safety.json ëˆ„ë½ í•­ëª© í™•ì¸"""
    print("\nğŸ“‹ 23. food_safety.json ëˆ„ë½ í™•ì¸")
    print("-" * 40)

    safety_path = SETTINGS_DIR / "food_safety.json"
    safety_data = json.loads(safety_path.read_text())

    # ëª¨ë“  ë“±ë¡ëœ ìŒì‹ ID
    registered = set()
    for level in ["safe", "caution", "danger"]:
        registered.update(safety_data.get(level, []))

    # contents/ í´ë”ì˜ ìŒì‹ ID
    missing = []
    for folder in CONTENTS_DIR.iterdir():
        if not folder.is_dir() or folder.name.startswith((".", "ğŸ”’")):
            continue

        parts = folder.name.split("_")
        if len(parts) >= 2:
            food_id = parts[1]
            if food_id not in registered and food_id not in ["reference", "sunshine"]:
                missing.append(food_id)
                print(f"  âš ï¸ ëˆ„ë½: {food_id}")

    print(f"\n  ì´ {len(missing)}ê°œ ëˆ„ë½")
    return missing


def enrich_korean_names():
    """24ë²ˆ: í•œê¸€ëª… ëˆ„ë½ ë³´ê°•"""
    print("\nğŸ“‹ 24. í•œê¸€ëª… ë³´ê°•")
    print("-" * 40)

    fixed = 0
    for folder in CONTENTS_DIR.iterdir():
        if not folder.is_dir() or folder.name.startswith((".", "ğŸ”’")):
            continue

        meta_path = folder / "metadata.json"
        if not meta_path.exists():
            continue

        # í´ë”ëª…ì—ì„œ í•œê¸€ëª… ì¶”ì¶œ
        parts = folder.name.split("_")
        if len(parts) >= 3:
            food_kr = parts[2]
        else:
            continue

        meta = json.loads(meta_path.read_text())
        if "food_name_ko" not in meta or not meta["food_name_ko"]:
            meta["food_name_ko"] = food_kr
            meta_path.write_text(json.dumps(meta, ensure_ascii=False, indent=2))
            print(f"  âœ… ì¶”ê°€: {folder.name} â†’ {food_kr}")
            fixed += 1

    print(f"\n  ì´ {fixed}ê°œ ë³´ê°•")
    return fixed


def create_caption_templates():
    """26ë²ˆ: ìº¡ì…˜ í…œí”Œë¦¿ ìƒì„±"""
    print("\nğŸ“‹ 26. ìº¡ì…˜ í…œí”Œë¦¿ ìƒì„±")
    print("-" * 40)

    captions_dir = CONFIG_DIR / "captions"
    captions_dir.mkdir(exist_ok=True)

    templates = {
        "SAFE": """ğŸ• ê°•ì•„ì§€ë„ ë¨¹ì„ ìˆ˜ ìˆì–´ìš”!

{food_name}ì˜ íš¨ëŠ¥:
âœ… {benefit_1}
âœ… {benefit_2}
âœ… {benefit_3}

ğŸ“Œ ê¸‰ì—¬ëŸ‰: {serving_size}
âš ï¸ ì²˜ìŒ ë¨¹ì¼ ë•ŒëŠ” ì†ŒëŸ‰ë¶€í„°!

ğŸ’¾ ì €ì¥í•´ë‘ê³  ê¸‰ì—¬ ì „ í™•ì¸í•˜ì„¸ìš”!
ğŸ¶ ë‹¤ë¥¸ ê²¬ì£¼ë‹˜ê»˜ ê³µìœ í•´ì£¼ì„¸ìš”!

â„¹ï¸ ì¼ë¶€ ì´ë¯¸ì§€ëŠ” AIë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
â„¹ï¸ Some images were generated by AI.

#ê°•ì•„ì§€ê°„ì‹ #ë°˜ë ¤ê²¬ê±´ê°• #{food_hashtag} #ê°•ì•„ì§€ìŒì‹ #í–‡ì‚´ì´""",

        "CAUTION": """âš ï¸ ì£¼ì˜í•´ì„œ ê¸‰ì—¬í•˜ì„¸ìš”!

{food_name} ê¸‰ì—¬ ì‹œ ì£¼ì˜ì‚¬í•­:
âš ï¸ {caution_1}
âš ï¸ {caution_2}
âš ï¸ {caution_3}

ğŸ“Œ ê¶Œì¥ëŸ‰: {serving_size}
ğŸš« ê³¼ê¸‰ì—¬ ì‹œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥

ğŸ’¾ ì €ì¥í•´ë‘ê³  ì°¸ê³ í•˜ì„¸ìš”!
ğŸ¶ ë‹¤ë¥¸ ê²¬ì£¼ë‹˜ê»˜ ê³µìœ í•´ì£¼ì„¸ìš”!

â„¹ï¸ ì¼ë¶€ ì´ë¯¸ì§€ëŠ” AIë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
â„¹ï¸ Some images were generated by AI.

#ê°•ì•„ì§€ê°„ì‹ #ë°˜ë ¤ê²¬ê±´ê°• #{food_hashtag} #ê°•ì•„ì§€ìŒì‹ì£¼ì˜ #í–‡ì‚´ì´""",

        "DANGER": """ğŸš« ì ˆëŒ€ ê¸‰ì—¬ ê¸ˆì§€!

{food_name}ê°€ ìœ„í—˜í•œ ì´ìœ :
âŒ {danger_1}
âŒ {danger_2}
âŒ {danger_3}

âš ï¸ ì‹¤ìˆ˜ë¡œ ì„­ì·¨ ì‹œ ì¦‰ì‹œ ìˆ˜ì˜ì‚¬ ìƒë‹´!

ğŸ’¾ ì €ì¥í•´ë‘ê³  ì°¸ê³ í•˜ì„¸ìš”!
ğŸ¶ ë‹¤ë¥¸ ê²¬ì£¼ë‹˜ê»˜ ê³µìœ í•´ì£¼ì„¸ìš”!

â„¹ï¸ ì¼ë¶€ ì´ë¯¸ì§€ëŠ” AIë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
â„¹ï¸ Some images were generated by AI.

#ê°•ì•„ì§€ê¸‰ì—¬ê¸ˆì§€ #ë°˜ë ¤ê²¬ê±´ê°• #{food_hashtag} #ë…ì„±ìŒì‹ #í–‡ì‚´ì´"""
    }

    for level, template in templates.items():
        path = captions_dir / f"{level}.txt"
        path.write_text(template)
        print(f"  âœ… {path.name}")

    print(f"\n  ì´ {len(templates)}ê°œ í…œí”Œë¦¿ ìƒì„±")


def create_posting_schedule():
    """27ë²ˆ: posting_schedule.json ìƒì„±"""
    print("\nğŸ“‹ 27. ê²Œì‹œ ìŠ¤ì¼€ì¤„ ìƒì„±")
    print("-" * 40)

    # cover_only ìƒíƒœì¸ ì½˜í…ì¸  ì°¾ê¸°
    pending = []
    for folder in sorted(CONTENTS_DIR.iterdir()):
        if not folder.is_dir() or folder.name.startswith((".", "ğŸ”’")):
            continue

        meta_path = folder / "metadata.json"
        if meta_path.exists():
            meta = json.loads(meta_path.read_text())
            status = meta.get("status", "unknown")
            if status in ("cover_only", "verified"):
                parts = folder.name.split("_")
                if len(parts) >= 2:
                    pending.append({
                        "food_id": parts[1],
                        "folder": folder.name,
                        "status": status
                    })

    # ìŠ¤ì¼€ì¤„ ìƒì„± (2ì¼ ê°„ê²©)
    schedule = []
    base_date = datetime.now() + timedelta(days=1)

    for i, item in enumerate(pending[:14]):  # 2ì£¼ì¹˜
        planned_date = base_date + timedelta(days=i * 2)
        schedule.append({
            "food_id": item["food_id"],
            "folder": item["folder"],
            "planned_date": planned_date.strftime("%Y-%m-%d"),
            "status": "scheduled"
        })

    result = {
        "generated_at": datetime.now().isoformat(),
        "total_pending": len(pending),
        "scheduled": len(schedule),
        "schedule": schedule
    }

    schedule_path = SETTINGS_DIR / "publish_schedule.json"
    schedule_path.write_text(json.dumps(result, ensure_ascii=False, indent=2))
    print(f"  âœ… {schedule_path.name}")
    print(f"  ëŒ€ê¸° ì¤‘: {len(pending)}ê°œ")
    print(f"  ìŠ¤ì¼€ì¤„ë¨: {len(schedule)}ê°œ")


def run_all():
    print("=" * 60)
    print("ğŸ“Š ë°ì´í„° ë³´ê°• ì‹œì‘")
    print(f"ğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 60)

    check_food_safety()
    enrich_korean_names()
    create_caption_templates()
    create_posting_schedule()

    print("\n" + "=" * 60)
    print("âœ… ë°ì´í„° ë³´ê°• ì™„ë£Œ")
    print("=" * 60)


if __name__ == "__main__":
    run_all()
