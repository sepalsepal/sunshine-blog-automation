#!/usr/bin/env python3
"""
Pillow 기반 텍스트 오버레이 모듈 v1.0

Puppeteer → Pillow 전환으로 □□ 박스 문제 해결
- 폰트 파일 직접 지정으로 확정적 렌더링
- 한글 100% 지원 (NotoSansCJKkr)

작성: 최부장
승인: 박세준 PD
일시: 2026-02-04

규칙 출처: RULES_v1.0.md, CONTENT_PRODUCTION_GUIDE.md
"""

from pathlib import Path
from typing import Optional, Tuple, Dict, Any
from PIL import Image, ImageDraw, ImageFont

# 프로젝트 루트
PROJECT_ROOT = Path(__file__).parent.parent

# ============================================
# 폰트 설정
# ============================================

FONTS_DIR = PROJECT_ROOT / "config" / "fonts"

# 폰트 파일 매핑
FONT_FILES = {
    "black": FONTS_DIR / "NotoSansCJKkr-Black.otf",   # 900 weight
    "bold": FONTS_DIR / "NotoSansCJKkr-Bold.otf",     # 700 weight
    "medium": FONTS_DIR / "NotoSansCJKkr-Medium.otf", # 500 weight
}

# ============================================
# 안전도별 색상 (RULES_v1.0.md)
# ============================================

SAFETY_COLORS = {
    "safe": "#4CAF50",       # 녹색
    "caution": "#FFD93D",    # 노랑
    "danger": "#FF6B6B",     # 주황-빨강
    "forbidden": "#FF5252",  # 빨강
}

# ============================================
# 슬라이드 타입별 스펙
# ============================================

OVERLAY_SPECS = {
    "cover": {
        # 표지: 상단 150px에만 텍스트, 하단 텍스트 절대 금지
        "font_weight": "black",
        "font_size": 114,
        "color": "#FFFFFF",
        "position": "top_center",
        "position_y": 150,  # 상단에서 150px
        "bottom_text_allowed": False,  # 하단 텍스트 금지
        "shadow": True,
        "shadow_offset": 4,
        "shadow_color": (0, 0, 0, 153),  # rgba(0,0,0,0.6)
    },
    "body": {
        # 본문: 제목/부제목 색상 반드시 분리
        "title": {
            "font_weight": "black",
            "font_size": 72,
            "color_by_safety": True,  # FORBIDDEN → #FF5252
        },
        "subtitle": {
            "font_weight": "medium",
            "font_size": 36,
            "color": "#FFFFFF",  # 부제목은 항상 흰색
        },
        "position": "bottom_center",
        "position_y_offset": 150,
        "shadow": True,
        "shadow_offset": 4,
        "shadow_color": (0, 0, 0, 180),
    },
    "cta": {
        # CTA: 실사진만, 제목 노랑, 부제목 흰색
        "title": {
            "font_weight": "bold",
            "font_size": 64,
            "color": "#FFD93D",  # CTA는 항상 노랑 (안전도 무관)
        },
        "subtitle": {
            "font_weight": "medium",
            "font_size": 40,
            "color": "#FFFFFF",
        },
        "position": "bottom_center",
        "position_y_offset": 150,
        "shadow": True,
        "require_real_photo": True,  # AI 이미지 금지
    },
}


# ============================================
# 클린 이미지 검증 (2026-02-04 추가)
# ============================================

def validate_base_image(base_path: str, strict: bool = True) -> bool:
    """
    클린 베이스 이미지인지 검증

    파일 네이밍 규칙:
    - ✅ *_bg.png  = 클린 베이스 (텍스트 없음) → overlay 가능
    - ❌ *_00.png  = 최종 이미지 (텍스트 있음) → overlay 금지
    - ❌ *_01.png  = 최종 이미지 (텍스트 있음) → overlay 금지

    Args:
        base_path: 이미지 파일 경로
        strict: True면 예외 발생, False면 경고만

    Returns:
        bool: 유효하면 True

    Raises:
        ValueError: strict=True이고 클린 이미지가 아닌 경우
    """
    path_str = str(base_path)

    # _bg.png로 끝나면 클린 이미지
    if path_str.endswith('_bg.png'):
        return True

    # 최종 이미지 패턴 (_00.png ~ _99.png)
    import re
    if re.search(r'_\d{2}\.png$', path_str):
        error_msg = (
            f"❌ 클린 이미지(_bg.png)만 overlay 가능\n"
            f"   입력된 파일: {Path(base_path).name}\n"
            f"   → *_bg.png 파일을 사용하세요\n"
            f"   (예: banana_01_bg.png)"
        )
        if strict:
            raise ValueError(error_msg)
        else:
            print(f"[WARN] {error_msg}")
            return False

    # 기타 파일은 경고 후 허용 (기존 호환성)
    print(f"[WARN] 비표준 파일명: {Path(base_path).name} - _bg.png 사용 권장")
    return True


def validate_slide_type(slide_num: int, config: dict) -> bool:
    """
    슬라이드 타입별 규칙 강제 검증

    Args:
        slide_num: 슬라이드 번호 (0=표지, 1-2=본문, 3=CTA)
        config: 적용할 설정

    Raises:
        ValueError: 규칙 위반 시

    Returns:
        bool: 검증 통과 시 True
    """
    if slide_num == 0:  # Cover
        # 표지에 하단 텍스트 있으면 FAIL
        if config.get('bottom_text') or config.get('subtitle'):
            raise ValueError("❌ FAIL: 표지(00)에 하단 텍스트/부제목 금지")
        print(f"✅ 표지 규칙 검증 통과: 상단 텍스트만")

    elif slide_num in [1, 2]:  # Body
        # 제목/부제목 색상이 같으면 FAIL
        title_color = config.get('title_color', '#FF5252')
        subtitle_color = config.get('subtitle_color', '#FFFFFF')
        if title_color.upper() == subtitle_color.upper():
            raise ValueError(
                f"❌ FAIL: 본문({slide_num:02d}) 제목/부제목 색상 동일 금지\n"
                f"   제목: {title_color}, 부제목: {subtitle_color}"
            )
        print(f"✅ 본문 규칙 검증 통과: 제목({title_color})/부제목({subtitle_color}) 색상 분리")

    elif slide_num == 3:  # CTA
        # CTA는 실사진만 허용 (검증은 호출 측에서)
        image_source = config.get('image_source', 'photo_only')
        if image_source != 'photo_only':
            raise ValueError("❌ FAIL: CTA(03)는 실사진만 허용")
        print(f"✅ CTA 규칙 검증 통과: 실사진 사용")

    return True


def get_font(weight: str = "black", size: int = 72) -> ImageFont.FreeTypeFont:
    """
    폰트 로드 (한글 지원 확정)

    Args:
        weight: "black" | "bold" | "medium"
        size: 폰트 크기

    Returns:
        ImageFont 객체
    """
    font_path = FONT_FILES.get(weight, FONT_FILES["black"])

    if not font_path.exists():
        raise FileNotFoundError(f"폰트 파일 없음: {font_path}")

    return ImageFont.truetype(str(font_path), size)


def get_text_color(safety: str, slide_type: str = "body") -> str:
    """
    안전도에 따른 텍스트 색상 반환

    Args:
        safety: "safe" | "caution" | "danger" | "forbidden"
        slide_type: "cover" | "body" | "cta"

    Returns:
        HEX 색상 코드
    """
    if slide_type == "cover":
        return "#FFFFFF"  # 표지는 항상 흰색

    if slide_type == "cta":
        return "#FFD93D"  # CTA 제목은 노랑

    # 본문은 안전도에 따라
    return SAFETY_COLORS.get(safety.lower(), "#FFFFFF")


def hex_to_rgba(hex_color: str, alpha: int = 255) -> Tuple[int, int, int, int]:
    """HEX 색상을 RGBA 튜플로 변환"""
    hex_color = hex_color.lstrip('#')
    r = int(hex_color[0:2], 16)
    g = int(hex_color[2:4], 16)
    b = int(hex_color[4:6], 16)
    return (r, g, b, alpha)


def draw_text_with_shadow(
    draw: ImageDraw.Draw,
    position: Tuple[int, int],
    text: str,
    font: ImageFont.FreeTypeFont,
    fill_color: str,
    shadow: bool = True,
    shadow_offset: int = 4,
    shadow_color: Tuple[int, int, int, int] = (0, 0, 0, 180)
) -> None:
    """
    그림자 효과와 함께 텍스트 그리기

    Args:
        draw: ImageDraw 객체
        position: (x, y) 위치
        text: 텍스트 내용
        font: 폰트 객체
        fill_color: 텍스트 색상 (HEX)
        shadow: 그림자 사용 여부
        shadow_offset: 그림자 오프셋
        shadow_color: 그림자 색상 (RGBA)
    """
    x, y = position

    if shadow:
        # 다중 레이어 그림자로 블러 효과 시뮬레이션
        for offset in range(1, shadow_offset + 1):
            alpha = int(shadow_color[3] * (1 - offset / (shadow_offset + 1)))
            current_shadow = (shadow_color[0], shadow_color[1], shadow_color[2], alpha)
            draw.text((x + offset, y + offset), text, font=font, fill=current_shadow)

    # 메인 텍스트
    draw.text((x, y), text, font=font, fill=fill_color)


def apply_cover_overlay(
    image: Image.Image,
    title: str,
    food_name_ko: Optional[str] = None
) -> Image.Image:
    """
    표지 텍스트 오버레이 적용

    Args:
        image: PIL Image 객체
        title: 영문 제목 (예: "BANANA")
        food_name_ko: 한글 이름 (옵션)

    Returns:
        수정된 Image 객체
    """
    if image.mode != 'RGBA':
        image = image.convert('RGBA')

    draw = ImageDraw.Draw(image)
    img_width, img_height = image.size

    spec = OVERLAY_SPECS["cover"]
    font = get_font(spec["font_weight"], spec["font_size"])

    # 텍스트 크기 측정
    bbox = draw.textbbox((0, 0), title, font=font)
    text_width = bbox[2] - bbox[0]

    # 중앙 정렬
    x = (img_width - text_width) // 2
    y = spec["position_y"]

    # 그림자 + 텍스트
    draw_text_with_shadow(
        draw, (x, y), title, font,
        fill_color=spec["color"],
        shadow=spec["shadow"],
        shadow_offset=spec["shadow_offset"],
        shadow_color=spec["shadow_color"]
    )

    return image


def apply_body_overlay(
    image: Image.Image,
    title: str,
    subtitle: str = "",
    safety: str = "safe",
    config: Optional[Dict[str, Any]] = None
) -> Image.Image:
    """
    본문 텍스트 오버레이 적용

    Args:
        image: PIL Image 객체
        title: 제목 텍스트
        subtitle: 부제목 텍스트
        safety: 안전도 ("safe", "caution", "danger", "forbidden")
        config: 커스텀 설정 (옵션)

    Returns:
        수정된 Image 객체
    """
    if image.mode != 'RGBA':
        image = image.convert('RGBA')

    draw = ImageDraw.Draw(image)
    img_width, img_height = image.size

    # 기본 스펙 + 커스텀 설정 병합
    spec = OVERLAY_SPECS["body"].copy()
    if config:
        spec.update(config)

    # 색상 결정
    if spec.get("color_by_safety"):
        text_color = get_text_color(safety, "body")
    else:
        text_color = spec.get("color", "#FFFFFF")

    # 폰트 로드
    font_size = spec.get("font_size", 72)
    font = get_font(spec.get("font_weight", "black"), font_size)
    subtitle_font = get_font("medium", int(font_size * 0.5))

    # 텍스트 크기 측정
    bbox = draw.textbbox((0, 0), title, font=font)
    text_width = bbox[2] - bbox[0]
    text_height = bbox[3] - bbox[1]

    # 위치 계산 (하단 중앙)
    x = (img_width - text_width) // 2
    y = img_height - text_height - spec.get("position_y_offset", 150)

    # 그림자 + 제목
    draw_text_with_shadow(
        draw, (x, y), title, font,
        fill_color=text_color,
        shadow=spec.get("shadow", True),
        shadow_offset=spec.get("shadow_offset", 4),
        shadow_color=spec.get("shadow_color", (0, 0, 0, 180))
    )

    # 부제목 (있으면)
    if subtitle:
        sub_bbox = draw.textbbox((0, 0), subtitle, font=subtitle_font)
        sub_width = sub_bbox[2] - sub_bbox[0]
        sub_x = (img_width - sub_width) // 2
        sub_y = y + text_height + 20

        draw_text_with_shadow(
            draw, (sub_x, sub_y), subtitle, subtitle_font,
            fill_color=text_color,
            shadow=True,
            shadow_offset=2,
            shadow_color=(0, 0, 0, 150)
        )

    return image


def apply_cta_overlay(
    image: Image.Image,
    title: str = "저장 & 공유",
    subtitle: str = "주변 견주에게 알려주세요!"
) -> Image.Image:
    """
    CTA 슬라이드 텍스트 오버레이

    Args:
        image: PIL Image 객체
        title: CTA 제목
        subtitle: CTA 부제목

    Returns:
        수정된 Image 객체
    """
    if image.mode != 'RGBA':
        image = image.convert('RGBA')

    draw = ImageDraw.Draw(image)
    img_width, img_height = image.size

    spec = OVERLAY_SPECS["cta"]

    # 제목 폰트
    title_font = get_font(
        spec["title"]["font_weight"],
        spec["title"]["font_size"]
    )

    # 부제목 폰트
    subtitle_font = get_font(
        spec["subtitle"]["font_weight"],
        spec["subtitle"]["font_size"]
    )

    # 제목 위치 계산
    title_bbox = draw.textbbox((0, 0), title, font=title_font)
    title_width = title_bbox[2] - title_bbox[0]
    title_height = title_bbox[3] - title_bbox[1]

    title_x = (img_width - title_width) // 2
    title_y = img_height - title_height - spec["position_y_offset"] - 50

    # 제목 그리기
    draw_text_with_shadow(
        draw, (title_x, title_y), title, title_font,
        fill_color=spec["title"]["color"],
        shadow=spec["shadow"],
        shadow_offset=4
    )

    # 부제목 위치 계산
    if subtitle:
        sub_bbox = draw.textbbox((0, 0), subtitle, font=subtitle_font)
        sub_width = sub_bbox[2] - sub_bbox[0]
        sub_x = (img_width - sub_width) // 2
        sub_y = title_y + title_height + 20

        draw_text_with_shadow(
            draw, (sub_x, sub_y), subtitle, subtitle_font,
            fill_color=spec["subtitle"]["color"],
            shadow=True,
            shadow_offset=2
        )

    return image


def overlay_from_config(
    image_path: Path,
    slide_index: int,
    text_config: Dict[str, Any],
    safety: str = "safe",
    skip_validation: bool = False
) -> bool:
    """
    설정 기반 오버레이 적용 (reoverlay.py 호환용)

    Args:
        image_path: 이미지 파일 경로
        slide_index: 슬라이드 번호 (0=표지, 1~3=본문)
        text_config: 텍스트 설정 딕셔너리
        safety: 안전도
        skip_validation: True면 클린 이미지 검증 스킵 (reoverlay용)

    Returns:
        성공 여부
    """
    try:
        # 클린 이미지 검증 (reoverlay는 스킵)
        if not skip_validation:
            validate_base_image(str(image_path), strict=True)

        image = Image.open(image_path)

        # 슬라이드 텍스트 가져오기
        slides = text_config.get("slides", [])
        if slide_index < len(slides):
            slide_text = slides[slide_index]
            title = slide_text.get("title", "")
            subtitle = slide_text.get("subtitle", "")
        else:
            return True  # 텍스트 없으면 성공 처리

        if not title:
            return True  # 텍스트 없으면 성공 처리

        # 커스텀 설정 추출
        custom_config = {
            "font_size": text_config.get("font_size", 72),
            "color": text_config.get("color"),
        }

        # 슬라이드 타입별 오버레이 적용
        if slide_index == 0:
            # 표지
            result = apply_cover_overlay(image, title)
        elif slide_index == 3 or "저장" in title or "공유" in title:
            # CTA
            result = apply_cta_overlay(image, title, subtitle)
        else:
            # 본문
            result = apply_body_overlay(
                image, title, subtitle,
                safety=safety,
                config=custom_config if custom_config.get("color") else None
            )

        # 저장
        if image_path.suffix.lower() == '.png':
            result.save(image_path, 'PNG')
        else:
            result = result.convert('RGB')
            result.save(image_path, 'JPEG', quality=95)

        return True

    except Exception as e:
        print(f"[ERROR] pillow_overlay 실패: {image_path.name} - {e}")
        return False


# ============================================
# 파일 기반 래퍼 함수 (클린 이미지 검증 포함)
# ============================================

def create_cover(base_path: str, title: str, output_path: str) -> bool:
    """
    표지 이미지 생성 (클린 베이스 → 최종 이미지)

    Args:
        base_path: 클린 베이스 이미지 (*_bg.png)
        title: 영문 제목 (예: "BANANA")
        output_path: 출력 경로 (*_00.png)

    Returns:
        성공 여부
    """
    validate_base_image(base_path, strict=True)

    try:
        image = Image.open(base_path)
        result = apply_cover_overlay(image, title)

        if output_path.endswith('.png'):
            result.save(output_path, 'PNG')
        else:
            result = result.convert('RGB')
            result.save(output_path, 'JPEG', quality=95)

        print(f"[OK] create_cover: {Path(output_path).name}")
        return True
    except Exception as e:
        print(f"[ERROR] create_cover 실패: {e}")
        return False


def create_body(
    base_path: str,
    title: str,
    subtitle: str,
    output_path: str,
    safety: str = "safe"
) -> bool:
    """
    본문 이미지 생성 (클린 베이스 → 최종 이미지)

    Args:
        base_path: 클린 베이스 이미지 (*_bg.png)
        title: 제목 텍스트
        subtitle: 부제목 텍스트
        output_path: 출력 경로 (*_01.png, *_02.png 등)
        safety: 안전도 ("safe", "caution", "danger", "forbidden")

    Returns:
        성공 여부
    """
    validate_base_image(base_path, strict=True)

    try:
        image = Image.open(base_path)
        result = apply_body_overlay(image, title, subtitle, safety=safety)

        if output_path.endswith('.png'):
            result.save(output_path, 'PNG')
        else:
            result = result.convert('RGB')
            result.save(output_path, 'JPEG', quality=95)

        print(f"[OK] create_body: {Path(output_path).name}")
        return True
    except Exception as e:
        print(f"[ERROR] create_body 실패: {e}")
        return False


def create_cta(
    base_path: str,
    output_path: str,
    title: str = "저장 & 공유",
    subtitle: str = "주변 견주에게 알려주세요!"
) -> bool:
    """
    CTA 이미지 생성 (클린 베이스 → 최종 이미지)

    Args:
        base_path: 클린 베이스 이미지 (*_bg.png)
        output_path: 출력 경로 (*_03.png)
        title: CTA 제목
        subtitle: CTA 부제목

    Returns:
        성공 여부
    """
    validate_base_image(base_path, strict=True)

    try:
        image = Image.open(base_path)
        result = apply_cta_overlay(image, title, subtitle)

        if output_path.endswith('.png'):
            result.save(output_path, 'PNG')
        else:
            result = result.convert('RGB')
            result.save(output_path, 'JPEG', quality=95)

        print(f"[OK] create_cta: {Path(output_path).name}")
        return True
    except Exception as e:
        print(f"[ERROR] create_cta 실패: {e}")
        return False


# ============================================
# CLI 테스트용
# ============================================

if __name__ == "__main__":
    import sys

    print("=" * 50)
    print("Pillow Overlay 테스트")
    print("=" * 50)

    # 폰트 로드 테스트
    try:
        font_black = get_font("black", 72)
        font_bold = get_font("bold", 64)
        font_medium = get_font("medium", 40)
        print("[OK] 폰트 로드 성공")
        print(f"  - Black: {FONT_FILES['black'].name}")
        print(f"  - Bold: {FONT_FILES['bold'].name}")
        print(f"  - Medium: {FONT_FILES['medium'].name}")
    except Exception as e:
        print(f"[FAIL] 폰트 로드 실패: {e}")
        sys.exit(1)

    # 색상 테스트
    print("\n[색상 테스트]")
    for safety in ["safe", "caution", "danger", "forbidden"]:
        color = get_text_color(safety)
        print(f"  - {safety}: {color}")

    print("\n[OK] 모든 테스트 통과")
