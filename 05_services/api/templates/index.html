{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - Project Sunshine{% endblock %}

{% block content %}
<div class="row">
    <!-- í™˜ì˜ ë©”ì‹œì§€ -->
    <div class="col-12 mb-4">
        <div class="card bg-gradient" style="background: linear-gradient(135deg, #FFD700, #FFA500);">
            <div class="card-body text-center py-4">
                <div class="dog-emoji mb-2">ğŸ•</div>
                <h2 class="mb-1">Project Sunshine v5.0</h2>
                <p class="mb-0">í–‡ì‚´ì´ì™€ í•¨ê»˜í•˜ëŠ” ë°˜ë ¤ê²¬ ìŒì‹ ì •ë³´ ìë™í™”</p>
            </div>
        </div>
    </div>

    <!-- ë¹ ë¥¸ ì‹œì‘ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-rocket-takeoff"></i> ë¹ ë¥¸ ì‹œì‘</h5>
            </div>
            <div class="card-body">
                <a href="/create" class="btn btn-sunshine btn-lg w-100 mb-3">
                    <i class="bi bi-plus-circle"></i> ìƒˆ ì½˜í…ì¸  ì œì‘
                </a>

                <div class="list-group">
                    <a href="/create?topic=apple" class="list-group-item list-group-item-action">
                        <i class="bi bi-apple"></i> ì‚¬ê³¼ ì½˜í…ì¸  ì œì‘
                    </a>
                    <a href="/create?topic=banana" class="list-group-item list-group-item-action">
                        <i class="bi bi-basket"></i> ë°”ë‚˜ë‚˜ ì½˜í…ì¸  ì œì‘
                    </a>
                    <a href="/create?topic=carrot" class="list-group-item list-group-item-action">
                        <i class="bi bi-carrot"></i> ë‹¹ê·¼ ì½˜í…ì¸  ì œì‘
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-speedometer2"></i> ì‹œìŠ¤í…œ ìƒíƒœ</h5>
            </div>
            <div class="card-body">
                <div id="system-status">
                    <div class="d-flex justify-content-between mb-3">
                        <span>API ì„œë²„</span>
                        <span id="api-status" class="badge bg-secondary">í™•ì¸ì¤‘...</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>ì—ì´ì „íŠ¸</span>
                        <span id="agents-count" class="badge bg-secondary">-</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>ì‹¤í–‰ì¤‘ì¸ íŒŒì´í”„ë¼ì¸</span>
                        <span id="running-count" class="badge bg-secondary">-</span>
                    </div>
                </div>

                <hr>

                <div class="small text-muted">
                    <div><i class="bi bi-clock"></i> ê°€ë™ ì‹œê°„: <span id="uptime">-</span></div>
                    <div><i class="bi bi-tag"></i> ë²„ì „: v5.0.0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìµœê·¼ íŒŒì´í”„ë¼ì¸ -->
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> ìµœê·¼ ì œì‘ ì´ë ¥</h5>
                <a href="/history" class="btn btn-sm btn-outline-secondary">ì „ì²´ë³´ê¸°</a>
            </div>
            <div class="card-body">
                <div id="recent-pipelines" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ì£¼ì œ</th>
                                <th>ìƒíƒœ</th>
                                <th>ì‹œì‘ ì‹œê°„</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="pipelines-tbody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">ë¡œë”© ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì—ì´ì „íŠ¸ ì†Œê°œ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-people"></i> ì œì‘íŒ€ ì†Œê°œ</h5>
            </div>
            <div class="card-body">
                <div class="row g-3" id="agents-list">
                    <!-- ì—ì´ì „íŠ¸ ì¹´ë“œê°€ ì—¬ê¸°ì— ë¡œë“œë¨ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadSystemStatus();
    loadPipelines();
    loadAgents();
});

async function loadSystemStatus() {
    try {
        const resp = await fetch('/health');
        const data = await resp.json();

        document.getElementById('api-status').textContent = data.status === 'healthy' ? 'ì •ìƒ' : 'ì˜¤ë¥˜';
        document.getElementById('api-status').className = 'badge ' + (data.status === 'healthy' ? 'bg-success' : 'bg-danger');

        document.getElementById('agents-count').textContent = data.agents_loaded + 'ëª…';
        document.getElementById('agents-count').className = 'badge bg-info';

        const uptime = Math.floor(data.uptime_seconds);
        const hours = Math.floor(uptime / 3600);
        const minutes = Math.floor((uptime % 3600) / 60);
        document.getElementById('uptime').textContent = `${hours}ì‹œê°„ ${minutes}ë¶„`;

    } catch (e) {
        document.getElementById('api-status').textContent = 'ì—°ê²° ì‹¤íŒ¨';
        document.getElementById('api-status').className = 'badge bg-danger';
    }
}

async function loadPipelines() {
    try {
        const resp = await fetch('/api/pipelines');
        const data = await resp.json();

        const tbody = document.getElementById('pipelines-tbody');

        if (data.pipelines.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ì œì‘ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            document.getElementById('running-count').textContent = '0';
            return;
        }

        const running = data.pipelines.filter(p => p.status === 'running').length;
        document.getElementById('running-count').textContent = running;
        document.getElementById('running-count').className = 'badge ' + (running > 0 ? 'bg-warning text-dark' : 'bg-success');

        tbody.innerHTML = data.pipelines.slice(0, 5).map(p => `
            <tr>
                <td><code>${p.id}</code></td>
                <td>${p.topic}</td>
                <td><span class="badge ${getStatusBadge(p.status)}">${getStatusText(p.status)}</span></td>
                <td>${new Date(p.started_at).toLocaleString('ko-KR')}</td>
                <td>
                    <a href="/pipeline/${p.id}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i>
                    </a>
                </td>
            </tr>
        `).join('');

    } catch (e) {
        console.error('íŒŒì´í”„ë¼ì¸ ë¡œë“œ ì‹¤íŒ¨:', e);
    }
}

async function loadAgents() {
    try {
        const resp = await fetch('/api/agents');
        const data = await resp.json();

        const div = document.getElementById('agents-list');
        div.innerHTML = data.agents.map(a => `
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body text-center">
                        <div class="fs-1">${getAgentEmoji(a.role)}</div>
                        <h6 class="mb-1">${a.name}</h6>
                        <small class="text-muted">${a.role}</small>
                    </div>
                </div>
            </div>
        `).join('');

    } catch (e) {
        console.error('ì—ì´ì „íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', e);
    }
}

function getStatusBadge(status) {
    return {
        'pending': 'bg-secondary',
        'running': 'bg-warning text-dark',
        'completed': 'bg-success',
        'failed': 'bg-danger',
        'awaiting_approval': 'bg-info'
    }[status] || 'bg-secondary';
}

function getStatusText(status) {
    return {
        'pending': 'ëŒ€ê¸°',
        'running': 'ì‹¤í–‰ì¤‘',
        'completed': 'ì™„ë£Œ',
        'failed': 'ì‹¤íŒ¨',
        'awaiting_approval': 'ìŠ¹ì¸ëŒ€ê¸°'
    }[status] || status;
}

function getAgentEmoji(role) {
    return {
        'ê¸°íš': 'ğŸ“‹',
        'íŒ©íŠ¸ì²´í¬': 'ğŸ”',
        'í…ìŠ¤íŠ¸': 'âœï¸',
        'ì´ë¯¸ì§€': 'ğŸ¨',
        'í¸ì§‘': 'ğŸ–¼ï¸',
        'ê²€ìˆ˜': 'âœ…',
        'ìº¡ì…˜': 'ğŸ’¬',
        'ê²Œì‹œ': 'ğŸ“¤'
    }[role] || 'ğŸ‘¤';
}
</script>
{% endblock %}
