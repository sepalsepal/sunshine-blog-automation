{% extends "base.html" %}

{% block title %}íŒŒì´ë„ ìŠ¹ì¸ - {{ topic | upper }}{% endblock %}

{% block extra_css %}
<style>
    .preview-header {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
    }

    .score-display {
        font-size: 3em;
        font-weight: bold;
    }

    .score-pass {
        color: #28a745;
    }

    .score-warning {
        color: #ffc107;
    }

    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }

    .image-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

    .image-card:hover {
        transform: scale(1.02);
    }

    .image-card img {
        width: 100%;
        height: auto;
        display: block;
    }

    .image-card .badge {
        position: absolute;
        top: 10px;
        left: 10px;
    }

    .caption-box {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        white-space: pre-wrap;
        font-family: inherit;
    }

    .approval-section {
        position: sticky;
        bottom: 20px;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    }

    .btn-approve {
        background: #28a745;
        color: white;
        padding: 15px 40px;
        font-size: 1.2em;
    }

    .btn-reject {
        background: #dc3545;
        color: white;
        padding: 15px 40px;
        font-size: 1.2em;
    }
</style>
{% endblock %}

{% block content %}
<div class="preview-header text-center">
    <h1>ğŸ¬ íŒŒì´ë„ ìŠ¹ì¸ ìš”ì²­</h1>
    <p class="lead mb-0">{{ topic | upper }} ì½˜í…ì¸  ë¯¸ë¦¬ë³´ê¸°</p>
</div>

<!-- ìš”ì•½ ì •ë³´ -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="small text-muted">ì½˜í…ì¸ </div>
                <div class="fs-3 fw-bold">{{ topic | upper }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="small text-muted">ìµœì¢… ì ìˆ˜</div>
                <div class="score-display {{ 'score-pass' if score >= 90 else 'score-warning' }}">
                    {{ score }}ì 
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="small text-muted">ì´ë¯¸ì§€</div>
                <div class="fs-3 fw-bold">{{ images | length }}ì¥</div>
            </div>
        </div>
    </div>
</div>

<!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
<div class="card mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-images"></i> ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</h5>
    </div>
    <div class="card-body">
        <div class="image-grid">
            {% for image in images %}
            <div class="image-card position-relative">
                <span class="badge bg-dark">{{ loop.index }}/{{ images | length }}</span>
                <img src="/api/images/{{ topic }}/{{ image }}" alt="Slide {{ loop.index }}"
                     onclick="showFullImage(this.src)">
            </div>
            {% else %}
            <div class="text-center text-muted p-4">
                <i class="bi bi-image fs-1"></i>
                <p>ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- ìº¡ì…˜ ë¯¸ë¦¬ë³´ê¸° -->
<div class="card mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-chat-quote"></i> ìº¡ì…˜</h5>
    </div>
    <div class="card-body">
        <div class="caption-box">{{ caption or 'ìº¡ì…˜ ì—†ìŒ' }}</div>
        {% if hashtags %}
        <div class="mt-3">
            <strong>í•´ì‹œíƒœê·¸:</strong>
            {% for tag in hashtags %}
            <span class="badge bg-primary me-1">#{{ tag }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- í’ˆì§ˆ ì ìˆ˜ ìƒì„¸ -->
<div class="card mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> ê²€ìˆ˜ ì ìˆ˜ ìƒì„¸</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="text-center p-3 rounded {{ 'bg-success text-white' if quality_scores.G1 >= 90 else 'bg-warning' }}">
                    <div class="small">G1 ê¸€ê²€ìˆ˜</div>
                    <div class="fs-3 fw-bold">{{ quality_scores.G1 or '-' }}ì </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-3 rounded {{ 'bg-success text-white' if quality_scores.G2 >= 90 else 'bg-warning' }}">
                    <div class="small">G2 ì´ë¯¸ì§€</div>
                    <div class="fs-3 fw-bold">{{ quality_scores.G2 or '-' }}ì </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-3 rounded {{ 'bg-success text-white' if quality_scores.G3 >= 90 else 'bg-warning' }}">
                    <div class="small">G3 í•©ì„±</div>
                    <div class="fs-3 fw-bold">{{ quality_scores.G3 or '-' }}ì </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìŠ¹ì¸ ì„¹ì…˜ -->
<div class="approval-section">
    <div class="row align-items-center">
        <div class="col-md-6">
            <p class="mb-0">
                <strong>íŒŒì´í”„ë¼ì¸ ID:</strong> <code>{{ pipeline_id }}</code>
            </p>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-approve me-2" onclick="approve()">
                <i class="bi bi-check-lg"></i> ìŠ¹ì¸ (ê²Œì‹œ ì§„í–‰)
            </button>
            <button class="btn btn-reject" onclick="showRejectForm()">
                <i class="bi bi-pencil"></i> ìˆ˜ì • ìš”ì²­
            </button>
        </div>
    </div>

    <!-- ìˆ˜ì • ìš”ì²­ í¼ -->
    <div id="reject-form" class="mt-3" style="display: none;">
        <div class="input-group">
            <textarea id="feedback" class="form-control" rows="2"
                      placeholder="ìˆ˜ì • ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <button class="btn btn-danger" onclick="reject()">
                <i class="bi bi-send"></i> ì „ì†¡
            </button>
        </div>
    </div>
</div>

<!-- ì „ì²´ ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img id="modalImage" src="" class="w-100">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const pipelineId = "{{ pipeline_id }}";

function showFullImage(src) {
    document.getElementById('modalImage').src = src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

function showRejectForm() {
    document.getElementById('reject-form').style.display = 'block';
    document.getElementById('feedback').focus();
}

async function approve() {
    if (!confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê²Œì‹œê°€ ì§„í–‰ë©ë‹ˆë‹¤.')) return;

    try {
        const response = await fetch(`/api/pipeline/${pipelineId}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pipeline_id: pipelineId,
                approved: true
            })
        });

        if (response.ok) {
            alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ê²Œì‹œê°€ ì§„í–‰ë©ë‹ˆë‹¤.');
            window.location.href = '/';
        } else {
            alert('ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨');
        }
    } catch (e) {
        alert('ì˜¤ë¥˜: ' + e.message);
    }
}

async function reject() {
    const feedback = document.getElementById('feedback').value.trim();
    if (!feedback) {
        alert('ìˆ˜ì • ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const response = await fetch(`/api/pipeline/${pipelineId}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pipeline_id: pipelineId,
                approved: false,
                feedback: feedback
            })
        });

        if (response.ok) {
            alert('ìˆ˜ì • ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/';
        } else {
            alert('ì²˜ë¦¬ ì‹¤íŒ¨');
        }
    } catch (e) {
        alert('ì˜¤ë¥˜: ' + e.message);
    }
}
</script>
{% endblock %}
