#!/usr/bin/env python3
"""
Î∞∞Ïπò ÏΩòÌÖêÏ∏† ÏÉùÏÑ±Í∏∞ - Î™®Îì† Ïª§Î≤ÑÏóê ÎåÄÌï¥ ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
v9.1 Í∑úÏπô Ï§ÄÏàò: Arial Black 114px, top 150px, 85% ÏÑ∏Ïù¥ÌîÑÏ°¥
"""

import os
import re
import json
from pathlib import Path
from PIL import Image, ImageDraw, ImageFont

# Í≤ΩÎ°ú ÏÑ§Ï†ï
BASE_DIR = Path("/Users/al02399300/Desktop/Jun_AI/Dog_Contents/project_sunshine")
COVER_DIR = BASE_DIR / "content/images/000_cover/02_ready"
CONTENT_DIR = BASE_DIR / "content/images"

# Ìè∞Ìä∏ ÏÑ§Ï†ï
ARIAL_BLACK = "/Library/Fonts/Arial Black.ttf"
FONT_SIZE = 114
TOP_Y = 150
MIN_FONT = 80

def get_font(path, size):
    try:
        return ImageFont.truetype(path, size)
    except:
        return ImageFont.load_default()

def add_text_with_shadow(draw, pos, text, font, fill):
    """v9 Í∑∏Î¶ºÏûê Ïä§Ìéô"""
    x, y = pos
    for offset in range(1, 8):
        alpha = int(180 * (1 - offset/8))
        draw.text((x, y + 4 + offset), text, font=font, fill=(0, 0, 0, alpha))
    draw.text(pos, text, font=font, fill=fill)

def apply_cover_text(input_path, output_path, title):
    """v9.1 ÌÖçÏä§Ìä∏ Ïò§Î≤ÑÎ†àÏù¥"""
    img = Image.open(input_path).convert("RGBA")

    if img.size != (1080, 1080):
        img = img.resize((1080, 1080), Image.LANCZOS)

    width, height = img.size
    overlay = Image.new("RGBA", img.size, (0, 0, 0, 0))
    draw = ImageDraw.Draw(overlay)

    font_size = FONT_SIZE
    max_width = width * 0.85

    while font_size >= MIN_FONT:
        font_title = get_font(ARIAL_BLACK, font_size)
        title_bbox = draw.textbbox((0, 0), title, font=font_title)
        title_w = title_bbox[2] - title_bbox[0]
        if title_w <= max_width:
            break
        font_size -= 10

    title_x = (width - title_w) // 2
    add_text_with_shadow(draw, (title_x, TOP_Y), title, font_title, (255, 255, 255, 255))

    result = Image.alpha_composite(img, overlay)
    result.convert("RGB").save(output_path, quality=95)

    return font_size

def parse_cover_filename(filename):
    """Ïª§Î≤Ñ ÌååÏùºÎ™Ö ÌååÏã±: cover_{num}_{korean}_{english}.png"""
    match = re.match(r'cover_(\d+)_([^_]+)_(.+?)(?:_DANGER)?(?:\d*)\.png', filename)
    if match:
        return {
            'num': int(match.group(1)),
            'korean': match.group(2),
            'english': match.group(3).replace('_DANGER', '').rstrip('0123456789'),
            'is_danger': 'DANGER' in filename
        }
    return None

def get_existing_content_folders():
    """Í∏∞Ï°¥ ÏΩòÌÖêÏ∏† Ìè¥Îçî Î™©Î°ù"""
    existing = set()
    for folder in CONTENT_DIR.iterdir():
        if folder.is_dir() and folder.name != '000_cover':
            # Ìè¥ÎçîÎ™ÖÏóêÏÑú ÏòÅÎ¨∏Î™Ö Ï∂îÏ∂ú
            match = re.match(r'\d+_([a-z_]+)', folder.name)
            if match:
                existing.add(match.group(1).rstrip('_'))
    return existing

def generate_caption_instagram(topic_kr, topic_en, is_danger=False):
    """Ïù∏Ïä§ÌÉÄÍ∑∏Îû® Ï∫°ÏÖò ÏÉùÏÑ±"""
    if is_danger:
        return f"""üö´ {topic_kr}, Í∞ïÏïÑÏßÄÍ∞Ä Î®πÏúºÎ©¥ Ïïà ÎèºÏöî!

Ïö∞Î¶¨ ÎåïÎåïÏù¥ÌïúÌÖå {topic_kr}ÏùÄ(Îäî) ÏúÑÌóòÌï¥Ïöî ‚ö†Ô∏è

‚ùå Ï†àÎåÄ Ï£ºÏßÄ ÎßàÏÑ∏Ïöî
‚ùå Ïã§ÏàòÎ°ú Î®πÏóàÎã§Î©¥ Ï¶âÏãú Î≥ëÏõêÏúºÎ°ú!

üìå Ï†ÄÏû•Ìï¥ÎëêÍ≥† Í∞ÄÏ°±Îì§Í≥º Í≥µÏú†ÌïòÏÑ∏Ïöî!

üí¨ Ïö∞Î¶¨ Ïßë ÎåïÎåïÏù¥ Ïù¥Î¶ÑÏùÄ?
ÎåìÍ∏ÄÎ°ú ÏïåÎ†§Ï£ºÏÑ∏Ïöî! üêæ

#Í∞ïÏïÑÏßÄ #Î∞òÎ†§Í≤¨ #Í∞ïÏïÑÏßÄÏùåÏãù #Í∞ïÏïÑÏßÄÍ∞ÑÏãù #ÎåïÎåïÏù¥ #Í≥®Îì†Î¶¨Ìä∏Î¶¨Î≤Ñ #ÌñáÏÇ¥Ïù¥ #{topic_en} #{topic_kr} #Í∞ïÏïÑÏßÄÍ∏àÏßÄÏùåÏãù #Ìé´Ïä§ÌÉÄÍ∑∏Îû® #Î©çÏä§ÌÉÄÍ∑∏Îû®

‚ÑπÔ∏è ÏùºÎ∂Ä Ïù¥ÎØ∏ÏßÄÎäî AIÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.
‚ÑπÔ∏è Some images were generated by AI."""
    else:
        return f"""‚úÖ {topic_kr}, Í∞ïÏïÑÏßÄÍ∞Ä Î®πÏñ¥ÎèÑ ÎèºÏöî!

11ÏÇ¥ ÌñáÏÇ¥Ïù¥ÎèÑ Ï¢ãÏïÑÌïòÎäî {topic_kr}! üêï

‚ú® Í∏âÏó¨ Ïãú Ï£ºÏùòÏÇ¨Ìï≠
- Ï†ÅÎãπÎüâÎßå Í∏âÏó¨ÌïòÏÑ∏Ïöî
- Ï≤òÏùåÏóî ÏÜåÎüâÏúºÎ°ú ÏãúÏûë
- ÏïåÎ†àÎ•¥Í∏∞ Î∞òÏùë ÌôïÏù∏

üìå Ï†ÄÏû•Ìï¥ÎëêÍ≥† ÎÇòÏ§ëÏóê Ï∞∏Í≥†ÌïòÏÑ∏Ïöî!

üí¨ Ïö∞Î¶¨ ÎåïÎåïÏù¥Í∞Ä Ï¢ãÏïÑÌïòÎäî ÏùåÏãùÏùÄ?
ÎåìÍ∏ÄÎ°ú ÏïåÎ†§Ï£ºÏÑ∏Ïöî! üêæ

#Í∞ïÏïÑÏßÄ #Î∞òÎ†§Í≤¨ #Í∞ïÏïÑÏßÄÏùåÏãù #Í∞ïÏïÑÏßÄÍ∞ÑÏãù #ÎåïÎåïÏù¥ #Í≥®Îì†Î¶¨Ìä∏Î¶¨Î≤Ñ #ÌñáÏÇ¥Ïù¥ #{topic_en} #{topic_kr} #Ìé´Ïä§ÌÉÄÍ∑∏Îû® #Î©çÏä§ÌÉÄÍ∑∏Îû®

‚ÑπÔ∏è ÏùºÎ∂Ä Ïù¥ÎØ∏ÏßÄÎäî AIÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.
‚ÑπÔ∏è Some images were generated by AI."""

def generate_caption_threads(topic_kr, topic_en, is_danger=False):
    """Ïì∞Î†àÎìú Ï∫°ÏÖò ÏÉùÏÑ±"""
    if is_danger:
        return f"""üö´ {topic_kr} - Í∞ïÏïÑÏßÄ Í∏àÏßÄ ÏùåÏãù!

Ï†àÎåÄ Ï£ºÏßÄ ÎßàÏÑ∏Ïöî ‚ö†Ô∏è

#Í∞ïÏïÑÏßÄ #{topic_kr} #Î∞òÎ†§Í≤¨"""
    else:
        return f"""‚úÖ {topic_kr} - Í∞ïÏïÑÏßÄÍ∞Ä Î®πÏñ¥ÎèÑ OK!

Ï†ÅÎãπÎüâ Í∏âÏó¨ÌïòÏÑ∏Ïöî üêï

#Í∞ïÏïÑÏßÄ #{topic_kr} #Î∞òÎ†§Í≤¨"""

def create_content(cover_info, cover_path):
    """ÏΩòÌÖêÏ∏† Ìè¥Îçî ÏÉùÏÑ± Î∞è ÌååÏùº ÏÉùÏÑ±"""
    num = cover_info['num']
    korean = cover_info['korean']
    english = cover_info['english']
    is_danger = cover_info['is_danger']

    # Ìè¥ÎçîÎ™Ö Í≤∞Ï†ï
    folder_name = f"{num:03d}_{english}_{korean}"
    content_folder = CONTENT_DIR / folder_name

    # Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎ©¥ Ïä§ÌÇµ
    if content_folder.exists():
        return None, "Ïù¥ÎØ∏ Ï°¥Ïû¨"

    # Ìè¥Îçî ÏÉùÏÑ±
    content_folder.mkdir(parents=True, exist_ok=True)

    # Ïª§Î≤Ñ Ïù¥ÎØ∏ÏßÄ Î≥µÏÇ¨ Î∞è ÌÖçÏä§Ìä∏ Ïò§Î≤ÑÎ†àÏù¥
    output_cover = content_folder / f"{english}_00.png"
    title = english.upper().replace('_', ' ')
    font_size = apply_cover_text(cover_path, output_cover, title)

    # Ï∫°ÏÖò ÏÉùÏÑ±
    caption_insta = content_folder / "caption_instagram.txt"
    caption_threads = content_folder / "caption_threads.txt"

    caption_insta.write_text(generate_caption_instagram(korean, english, is_danger), encoding='utf-8')
    caption_threads.write_text(generate_caption_threads(korean, english, is_danger), encoding='utf-8')

    return folder_name, f"ÏÉùÏÑ±ÏôÑÎ£å ({font_size}px)"

def main():
    print("=" * 60)
    print("üé® ÍπÄÏòÅÌòÑ Í≥ºÏû•ÏûÖÎãàÎã§. Î∞∞Ïπò ÏΩòÌÖêÏ∏† ÏÉùÏÑ±ÏùÑ ÏãúÏûëÌï©ÎãàÎã§.")
    print("=" * 60)

    # Ïª§Î≤Ñ ÌååÏùº Î™©Î°ù
    covers = list(COVER_DIR.glob("cover_*.png"))
    print(f"\nüìÅ Ï¥ù {len(covers)}Í∞ú Ïª§Î≤Ñ Î∞úÍ≤¨")

    created = []
    skipped = []
    errors = []

    for cover_path in sorted(covers):
        info = parse_cover_filename(cover_path.name)
        if not info:
            errors.append((cover_path.name, "ÌååÏùºÎ™Ö ÌååÏã± Ïã§Ìå®"))
            continue

        try:
            folder, status = create_content(info, cover_path)
            if folder:
                created.append((folder, status))
                print(f"  ‚úÖ {folder} - {status}")
            else:
                skipped.append((cover_path.name, status))
        except Exception as e:
            errors.append((cover_path.name, str(e)))
            print(f"  ‚ùå {cover_path.name} - {e}")

    print("\n" + "=" * 60)
    print("üìä Í≤∞Í≥º ÏöîÏïΩ")
    print("=" * 60)
    print(f"  ÏÉùÏÑ±: {len(created)}Í∞ú")
    print(f"  Ïä§ÌÇµ: {len(skipped)}Í∞ú (Ïù¥ÎØ∏ Ï°¥Ïû¨)")
    print(f"  Ïò§Î•ò: {len(errors)}Í∞ú")

    if created:
        print(f"\n‚úÖ ÏÉùÏÑ±Îêú ÏΩòÌÖêÏ∏† ({len(created)}Í∞ú):")
        for folder, status in created[:20]:  # Ï≤òÏùå 20Í∞úÎßå Ï∂úÎ†•
            print(f"    - {folder}")
        if len(created) > 20:
            print(f"    ... Ïô∏ {len(created) - 20}Í∞ú")

    if errors:
        print(f"\n‚ùå Ïò§Î•ò ({len(errors)}Í∞ú):")
        for name, err in errors:
            print(f"    - {name}: {err}")

    return created, skipped, errors

if __name__ == "__main__":
    main()
