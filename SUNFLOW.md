# SunFlow

> **Instagram 콘텐츠 자동화 시스템**
>
> 반려견 음식 정보 콘텐츠를 AI로 제작하고 자동 게시하는 올인원 솔루션

---

## Overview

| 항목 | 내용 |
|------|------|
| **서비스명** | SunFlow |
| **버전** | v1.3 (데이터 기반 운영) |
| **계정** | @sunshinedogfood |
| **캐릭터** | 햇살이 (골든 리트리버, 11살) |
| **완성도** | 기술 95%, 콘텐츠 90%, 수익화 85%, 문서화 95% (추정치, 분기별 재평가 예정) |
| **v1.3 핵심** | 30일 실운영 데이터 자동 수집 + PPL 슬롯 정책 |

---

## Core Features

### 1. 콘텐츠 제작 파이프라인
- AI 이미지 생성 (FLUX.2 Pro)
- PPT 템플릿 기반 텍스트 오버레이
- 캡션 + 해시태그 자동 생성
- 3단계 품질 게이트 (G1/G2/G3)

#### 표지 프롬프트 v2.0 (하이브리드) - Higgsfield 기반
```
┌─────────────────────────────────────────────┐
│  [CONTAINER RULE] - 자동 용기 분류          │
│  ├── Fresh Food/Fruit → 반려견 식기 브랜드  │
│  ├── Beverage → 해당 음료 대표 용기         │
│  ├── Branded drink → 원래 브랜드 캔/병      │
│  ├── Packaged snack → 원래 포장 그대로      │
│  └── Dog treats → 원래 포장 그대로          │
│                                             │
│  [VARIATION 시스템] - 10가지 자동 변화      │
│  ├── 시간대/조명: 골든아워/한낮/저녁/밤     │
│  ├── 강아지 표정: 혀내밀기/미소/호기심      │
│  ├── 카메라 앵글: 정면/왼쪽/오른쪽          │
│  ├── 시선: 카메라/음식/창밖                 │
│  ├── 창밖 날씨: 맑음/흐림/비/눈             │
│  ├── 테이블: 대리석/오크/월넛 등 10종       │
│  └── 액세서리: 가끔 반다나/스카프           │
│                                             │
│  [레이아웃] - 40% / 90% 규칙                │
│  ├── 강아지 머리 상단: 40% 위치             │
│  └── 용기 하단: 90% 위치                    │
└─────────────────────────────────────────────┘
```
> **상세 가이드:** `docs/PROMPT_GUIDE_v2.md` 참조

#### PPL 자연 노출 전략
| 우선순위 | 카테고리 | 노출 방식 | 예시 브랜드 |
|:--------:|----------|----------|-------------|
| ⭐⭐⭐⭐⭐ | 반려견 식기 | 음식 담는 그릇 | 르쿠제펫, 이케아펫 |
| ⭐⭐⭐⭐⭐ | 간식/사료 | 배경 제품 배치 | 오리젠, 아카나 |
| ⭐⭐⭐⭐ | 매트/러그 | 바닥 배경 | 펫프렌즈 |
| ⭐⭐⭐ | 액세서리 | 햇살이 착용 | 반다나, 넥카라 |

### 2. 자동 게시 시스템
- Instagram Graph API 캐러셀 게시
- Cloudinary CDN 업로드
- 대기열 자동 관리 (ContentQueue)
- 실패 시 자동 재시도 (최대 3회, 지수 백오프)

### 3. 스케줄링
- **오전 9시**: 커버 소스 자동 처리
- **오후 6시**: 콘텐츠 자동 게시
- **매일**: Instagram 통계 수집

### 4. 운영 도구
- Streamlit 대시보드
- 텔레그램 리모컨 (양방향)
- A/B 테스트 시스템
- 댓글 자동 응답

---

## Quick Start

```bash
# 대시보드 실행
streamlit run services/dashboard/app.py

# 텔레그램 봇 실행
python3 services/scripts/telegram_bot.py

# 콘텐츠 게시
python3 services/scripts/publish_content.py olive
```

---

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                      SunFlow                            │
├─────────────────────────────────────────────────────────┤
│  📥 Input                                               │
│  ├── PD 커버 이미지 (03_cover_sources/)                 │
│  ├── 주제 선정 (publishing_history.json)                │
│  ├── 스케줄 (publish_schedule.json)                     │
│  └── PPL 브랜드 목록 (brand_ppl.json)                   │
├─────────────────────────────────────────────────────────┤
│  ⚙️ Processing                                          │
│  ├── ImageAgent (FLUX.2 Pro)                            │
│  ├── TextOverlayAgent (PPT Template)                    │
│  ├── CaptionAgent (AI 캡션 생성)                        │
│  ├── QualityGate (G1/G2/G3)                             │
│  └── RetryManager (자동 재시도)                         │
├─────────────────────────────────────────────────────────┤
│  📤 Output                                              │
│  ├── Cloudinary (CDN)                                   │
│  ├── Instagram (Graph API)                              │
│  └── Telegram (알림)                                    │
├─────────────────────────────────────────────────────────┤
│  📊 Analytics                                           │
│  ├── instagram_stats.json                               │
│  ├── A/B Test Manager                                   │
│  ├── CommentResponder                                   │
│  └── Dashboard (Streamlit)                              │
└─────────────────────────────────────────────────────────┘
```

---

## Team (AI Agents)

| 이모지 | 이름 | 역할 |
|:------:|------|------|
| 👔 | 김부장 | 업무 분배, 최종 승인, 전략 기획 |
| 🎨 | 김영현 과장 | 이미지 생성 + 텍스트 합성 |
| 📣 | 송지영 대리 | 마케팅, 캡션, 게시, PPL 협찬 관리 |
| 🎬 | 김감독 | 품질 검수 (G1/G2/G3) |
| 📤 | 김대리 | 파일 정리, 업로드, **Gemini 분석 연동** |
| 🔬 | 최검증 | 팩트체크, 안전성 검증 |

### 김대리 확장 역할 (Gemini VLM 연동)

```
┌─────────────────────────────────────────────────────────────┐
│                 김대리 (Gemini) 업무 범위                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [이미지 검수] ← Vision API                                 │
│  ├── 햇살이 특징 검증 (흰 주둥이, 시니어 느낌)              │
│  ├── 금지 포즈 감지 (먹기/핥기/만지기)                      │
│  ├── 구도 검증 (상단 30% 여백, 음식 위치)                   │
│  └── 품질 점수 자동 산출 (G2 게이트 보조)                   │
│                                                             │
│  [캡션 생성] ← Gemini Pro                                   │
│  ├── 이미지 기반 캡션 초안                                  │
│  ├── 해시태그 트렌드 분석                                   │
│  └── CTA 문구 최적화                                        │
│                                                             │
│  [트렌드 분석] ← Gemini + 웹 검색                           │
│  ├── 경쟁 계정 벤치마킹                                     │
│  ├── 인기 음식 주제 발굴                                    │
│  └── 시즌별 콘텐츠 제안                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**김대리 자동화 트리거:**
- 이미지 생성 완료 시 → 자동 품질 검수
- 매주 월요일 → 트렌드 리포트 생성
- 게시 전 → 캡션 최적화 제안

---

## PPL 브랜드 전략

### 현황 (2026-01-30 기준)
- **등록 브랜드**: 20개
- **자연 노출 방식**: 프롬프트 내 제품 배치
- **광고 표기**: 자동화 (캡션 하단)

### 브랜드 우선순위 (PPL 적합도)

| 순위 | 카테고리 | 노출 방식 | 자연스러움 | 브랜드 예시 |
|:----:|----------|----------|:----------:|-------------|
| 1 | **반려견 식기** | 음식 담는 그릇 | ⭐⭐⭐⭐⭐ | Le Creuset Pet, Diggs, MiaCara, Cloud7, Fable Pets |
| 2 | **프리미엄 사료** | 원래 포장 노출 | ⭐⭐⭐⭐⭐ | 오리젠, 아카나, 지위픽, 하림펫푸드 |
| 3 | **영양제/간식** | 원래 포장 노출 | ⭐⭐⭐⭐ | 뉴트리플렉스, 그린비 |
| 4 | **액세서리** | 햇살이 착용 | ⭐⭐⭐ | 와일드원, 루시앤코 (반다나, 스카프) |
| 5 | **배경 소품** | 디포커스 배경 | ⭐ | PPL 비추천 (인식 어려움) |

### 반려견 식기 브랜드 20개

| 등급 | 브랜드 |
|------|--------|
| **프리미엄** | Le Creuset Pet, Diggs, MiaCara, Cloud7, Fable Pets |
| **중고가** | PETKIT, HARIO WAN, Waggo, Harry Barker, Messy Mutts |
| **인기** | Kong, Outward Hound, PetRageous, Loving Pets, Frisco |
| **한국** | 바잇미, 페슬러, 브리더랩, 뽀시래기, 아르르 |

### 프롬프트 PPL 삽입 예시
```
# 식기 PPL
"... food served in a stylish ceramic pet bowl with minimalist design ..."

# 매트 PPL
"... dog sitting on a premium silicone feeding mat ..."

# 사료 PPL (배경)
"... premium dog food bag visible in background ..."
```

### PPL 워크플로우
```
┌─────────────────────────────────────────────────────────────┐
│  브랜드 등록 → 주제 매칭 → 프롬프트 삽입 → 콘텐츠 제작     │
│       ↓                                                     │
│  광고 표기 자동화 → 게시 → 성과 측정 → 브랜드 리포트       │
└─────────────────────────────────────────────────────────────┘
```

### 광고 표기 자동화
```
캡션 하단 자동 추가:
"📢 본 콘텐츠에는 [브랜드명] 협찬이 포함되어 있습니다."
```

---

## 운영 안정성 (Production Readiness)

### 현재 상태: 95%

| 항목 | 상태 | 설명 |
|------|:----:|------|
| 에러 로깅 | ✅ | config/logs/ 폴더 |
| Trace ID | ✅ | 통합 TraceManager (SF-YYYYMMDD-XXXXXX) |
| 재시도 로직 | ✅ | RetryManager (3회, 지수 백오프) |
| 장애 알림 | ✅ | 텔레그램 알림 |
| 백업 | ✅ | 자동 일일 백업 (00:00) |
| 모니터링 | ✅ | Streamlit 대시보드 |
| 헬스체크 | ✅ | 7개 컴포넌트 점검 |
| 토큰 모니터링 | ✅ | 60일 전 만료 알림 |
| 롤백 시스템 | ✅ | 체크포인트 기반 복구 |
| 서킷 브레이커 | ✅ | API 장애 격리 (4개 회로) |
| 에러 집계 | ✅ | 일일/주간 리포트, 패턴 감지 |

### 계정 보호 시나리오

| 시나리오 | 대응 |
|----------|------|
| API Rate Limit | 자동 대기 + 텔레그램 알림 |
| 토큰 만료 | 갱신 알림 (60일 전) |
| 게시 실패 3회 | 자동 중단 + PD 알림 |
| 스팸 감지 | 댓글 응답 중단 |

### 완료된 항목 (2026-01-30)
- [x] 통합 Trace ID 시스템 (TraceManager)
- [x] 자동 백업 (일일 00:00, 30일 보존)
- [x] 헬스체크 시스템 (7개 컴포넌트)
- [x] 토큰 만료 모니터링
- [x] 롤백 시스템 (체크포인트 기반)
- [x] 서킷 브레이커 (API 장애 격리)
- [x] 에러 집계 시스템 (패턴 감지)

### 추가 필요 항목 (5%)
- [ ] Cloudinary 동기화 백업
- [ ] 외부 모니터링 연동 (선택)

---

## 플랫폼 리스크 대응

### Instagram 의존성 리스크

| 리스크 | 영향도 | 발생 확률 | 대응 전략 |
|--------|:------:|:--------:|-----------|
| API 정책 변경 | 높음 | 중간 | 버전 모니터링, 추상화 레이어 |
| 계정 일시 제한 | 높음 | 낮음 | Rate Limit 준수, 서킷 브레이커 |
| 콘텐츠 오탐 차단 | 중간 | 낮음 | 가이드라인 준수, 재심 요청 |
| 토큰 만료 | 높음 | 확정 | 60일 전 알림, 자동 갱신 가이드 |

### 대체 출력 채널 (플랜 B)

```
┌─────────────────────────────────────────────────────────────┐
│                   멀티 채널 확장 계획                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [현재]          [Phase 2]        [Phase 3]                 │
│  Instagram  →   + 블로그/웹    →  + YouTube Shorts          │
│              →   + 네이버포스트  →  + TikTok                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 계정 보호 강화

| 항목 | 현재 | 목표 |
|------|------|------|
| 일일 게시 횟수 | 1건 | 1건 유지 |
| 댓글 응답 제한 | 50건/일 | 30건/일로 하향 |
| API 호출 간격 | 최소 1초 | 최소 3초로 상향 |
| 백업 계정 | 없음 | 1개 준비 |

---

## 수익화 로드맵

```
┌─────────────────────────────────────────────────────────────┐
│                    SunFlow 수익화 여정                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Phase 1        Phase 2        Phase 3        Phase 4      │
│  팔로워 확보 →  PPL 시작   →  수익 다각화 →  SaaS 판매    │
│  (현재)         (6개월)        (12개월)       (18개월)      │
│                                                             │
│  1K 팔로워      5K 팔로워      10K 팔로워     시스템 판매   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Phase 1: 팔로워 확보 (현재)
| 항목 | 내용 |
|------|------|
| 목표 | 1,000 팔로워 |
| 전략 | 일일 1 콘텐츠, 품질 우선 |
| KPI | 팔로워 증가율, 참여율 |
| 예상 기간 | 3개월 |

### Phase 2: PPL 시작
| 항목 | 내용 |
|------|------|
| 목표 | 월 3건 협찬, 5,000 팔로워 |
| 전략 | 반려견 식기/사료 브랜드 컨택 |
| KPI | 협찬 단가, 전환율 |
| 예상 기간 | 6개월 후 |

### Phase 3: 수익 다각화
| 항목 | 내용 |
|------|------|
| 목표 | 월 100만원+ 수익, 10,000 팔로워 |
| 전략 | 스폰서십 + 굿즈 + 교육 콘텐츠 |
| KPI | MRR (월간 반복 수익) |
| 예상 기간 | 12개월 후 |

### Phase 4: SaaS 판매 (SunFlow as a Service)
| 항목 | 내용 |
|------|------|
| 목표 | SunFlow 시스템 B2B 판매 |
| 전략 | 반려동물 인플루언서/브랜드 대상 |
| 가격 | 월 29~99만원 (티어별) |
| KPI | 가입자 수, 이탈률 |
| 예상 기간 | 18개월 후 |

### 예상 수익 (Phase별)

| Phase | 월간 수익 | 주요 수익원 |
|:-----:|:---------:|-------------|
| 1 | 0원 | - |
| 2 | 30~50만원 | PPL 협찬 |
| 3 | 100~150만원 | PPL + 스폰서십 + 굿즈 |
| 4 | 300~500만원 | SaaS 구독료 + PPL |

### SaaS 티어 구성 (Phase 4)
| 티어 | 가격 | 기능 |
|------|------|------|
| Starter | 29만/월 | 콘텐츠 자동 생성 (월 30개) |
| Pro | 59만/월 | + 자동 게시 + 통계 |
| Enterprise | 99만/월 | + 커스텀 캐릭터 + 전담 지원 |

---

## File Structure

```
project_sunshine/
├── core/
│   ├── agents/          # AI 에이전트
│   └── utils/           # 유틸리티
│       ├── content_queue.py
│       ├── retry_manager.py
│       ├── ab_test_manager.py
│       └── comment_responder.py
├── services/
│   ├── dashboard/       # Streamlit 대시보드
│   └── scripts/         # 자동화 스크립트
│       ├── telegram_bot.py
│       ├── auto_scheduler.py
│       ├── cover_processor.py
│       └── launchd/     # macOS 스케줄러
├── config/
│   ├── settings/        # 설정 파일
│   └── data/            # 데이터 파일
└── content/
    └── images/          # 콘텐츠 이미지
        └── 000_cover/   # 커버 이미지
            ├── 01_published/
            ├── 02_ready/
            └── 03_cover_sources/
```

---

## Version History

| 버전 | 날짜 | 주요 변경 |
|------|------|----------|
| **v1.3** | **2026-01-30** | **30일 메트릭 자동 수집 + PPL 슬롯 정책 + 리뷰어 피드백 반영** |
| v1.2 | 2026-01-30 | 콘텐츠 제작 최적화 + PPL 전략 + 비즈니스 기준 문서화 |
| v1.1 | 2026-01-30 | 운영 안정성 95%, 롤백/서킷브레이커/에러집계 |
| v1.0 | 2026-01-30 | 정식 명명 "SunFlow", 전체 기능 완성 |
| v0.9 | 2026-01-29 | P2/P3 기능 추가 (A/B 테스트, 댓글 응답) |
| v0.8 | 2026-01-28 | 대시보드 v5.0, 4장 슬라이드 구조 |
| v0.5 | 2026-01-26 | v5 파이프라인, 7인 에이전트 체제 |

---

## Documentation

| 파일 | 용도 | Owner |
|------|------|-------|
| `SUNFLOW.md` | 서비스 개요 | 김부장 |
| `CLAUDE.md` | 개발 규칙 | 김부장 |
| `docs/OPERATIONS.md` | 운영 매뉴얼 | 김대리 |
| `docs/PLAYBOOK.md` | 장애 대응 | 김대리 |
| `docs/REVENUE_STRATEGY.md` | 매출 전략 | 송대리 |
| `docs/PRODUCTION_CHECKLIST.md` | 운영 체크리스트 | 김부장 |
| `docs/PROMPT_GUIDE_v2.md` | 표지 이미지 제작 | PD |
| `docs/PERFORMANCE_CRITERIA.md` | 성과 기준 정의 | 김부장 |
| `docs/PPL_PREREQUISITES.md` | PPL/스폰서십 조건 | 송대리 |
| `docs/PLATFORM_FAILURE_POLICY.md` | 플랫폼 실패 정책 | 김대리 |
| `docs/CONTENT_SLOT_POLICY.md` | PPL 슬롯/비율 정책 | 송대리 |
| `docs/OPERATIONAL_REPORT_TEMPLATE.md` | 30일 리포트 템플릿 | 김부장 |

### v1.3 신규 모듈

| 파일 | 용도 |
|------|------|
| `core/utils/metrics_collector.py` | 30일 메트릭 자동 수집 |
| `core/utils/metrics_hooks.py` | 파이프라인 메트릭 연동 |
| `services/scripts/generate_report.py` | 리포트 자동 생성 |

---

## v1.2 로드맵 (SunFlow Analytics)

> **목표:** "그래서 내일 뭘 바꿀지"를 시스템이 제안

### 핵심 기능

```
┌─────────────────────────────────────────────────────────────┐
│                  SunFlow Analytics v1.2                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [성과 분석]                                                │
│  ├── 콘텐츠별 성과 랭킹                                     │
│  ├── 시간대별 참여율 분석                                   │
│  └── 해시태그 효과 측정                                     │
│                                                             │
│  [자동 제안]                                                │
│  ├── 다음 주제 추천 (성과 기반)                             │
│  ├── 최적 게시 시간 제안                                    │
│  └── A/B 테스트 자동 승자 적용                              │
│                                                             │
│  [예측 모델]                                                │
│  ├── 콘텐츠 성과 예측                                       │
│  ├── 팔로워 증가 예측                                       │
│  └── PPL 효과 예측                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 예상 일정
| 기능 | 예상 기간 |
|------|----------|
| 성과 분석 대시보드 | 2주 |
| 자동 제안 시스템 | 3주 |
| 예측 모델 | 4주 |

---

## 최근 작업 (2026-01-30)

### v1.3 신규 (데이터 기반 운영)
- 30일 메트릭 자동 수집 시스템 (metrics_collector.py) ✅
- 파이프라인 메트릭 연동 훅 (metrics_hooks.py) ✅
- 리포트 자동 생성기 (generate_report.py) ✅
- PPL 콘텐츠 슬롯 정책 (CONTENT_SLOT_POLICY.md) ✅
- 광고/비광고 비율 명문화 (5:2) ✅
- 브랜드 반복 노출 정책 ✅
- 리뷰어 피드백 반영 (톤 조정, 측정 방법 추가) ✅

### v1.2 완료 (콘텐츠 제작 + PPL 전략)
- 표지 프롬프트 v2.0 하이브리드 (Higgsfield 기반) ✅
- CONTAINER RULE 자동 분류 시스템 ✅
- VARIATION 10가지 자동 변화 시스템 ✅
- 반려견 식기 브랜드 20개 선정 ✅
- PPL 최소 조건 수치화 (PPL_PREREQUISITES.md) ✅
- 성과 기준 정의서 (PERFORMANCE_CRITERIA.md) ✅
- 플랫폼 실패 허용 정책 (PLATFORM_FAILURE_POLICY.md) ✅
- 표지 이미지 제작 가이드 (PROMPT_GUIDE_v2.md) ✅

### v1.1 완료 (운영 안정성)
- 운영 안정성 개선 (70% → 95%) ✅
- 통합 Trace ID 시스템 ✅
- 자동 백업 시스템 ✅
- 헬스체크 시스템 ✅
- 토큰 만료 모니터링 ✅
- 롤백 시스템 ✅
- 서킷 브레이커 ✅
- 에러 집계 시스템 ✅
- 운영 매뉴얼 (OPERATIONS.md) ✅
- 장애 대응 플레이북 (PLAYBOOK.md) ✅

### v1.0 완료 (기본 기능)
- 표지 프롬프트 v2.0 (상단 30% 여백 확보) ✅
- 커버 소스 자동 처리 시스템 (오전 9시) ✅
- 텔레그램 양방향 리모컨 ✅
- 콘텐츠 큐 관리 시스템 ✅
- 자동 재시도 (지수 백오프) ✅
- A/B 테스트 프레임워크 ✅
- 댓글 자동 응답 ✅

---

## License

Private - Project Sunshine Team

---

---

## 멀티플랫폼 확장 (X, Threads)

### 콘텐츠 재활용 전략

```
[Instagram 원본]
    ↓ 자동 변환
├── X: 핵심 정보 280자 + 이미지 1장
├── Threads: 대화체 텍스트 + 이미지 1장
└── (향후) YouTube Shorts: 슬라이드 → 15초 영상
```

### 사용 방법

```bash
# 멀티플랫폼 상태 확인
python3 core/utils/multi_platform.py status

# 콘텐츠 미리보기 (변환 결과)
python3 core/utils/multi_platform.py preview

# 테스트 게시
python3 core/utils/multi_platform.py test
```

### 플랫폼별 설정

| 플랫폼 | 환경변수 | 상태 |
|--------|----------|:----:|
| Instagram | INSTAGRAM_ACCESS_TOKEN | ✅ |
| X | X_API_KEY, X_ACCESS_TOKEN | 설정 필요 |
| Threads | (Instagram 공유) | 설정 필요 |

---

*Powered by Claude Code + FLUX.2 Pro + Instagram Graph API*
