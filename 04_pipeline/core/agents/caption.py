"""
CaptionAgent - ìº¡ì…˜/ì¹´í”¼ ì „ë¬¸ê°€ (ì´ì¹´í”¼)

topics_expanded.jsonì—ì„œ ì£¼ì œ ì •ë³´ ë¡œë“œ
hashtag_strategy.jsonì—ì„œ í•´ì‹œíƒœê·¸ ì „ëµ ë¡œë“œ

Author: ì´ì¹´í”¼ (Lee Copy)
"""

import json
import random
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Optional
from .base import BaseAgent, AgentResult


# ì„¤ì • íŒŒì¼ ê²½ë¡œ
_CONFIG_DIR = Path(__file__).parent.parent / "config"


def _load_json(filename: str) -> Dict:
    """config/ ë””ë ‰í† ë¦¬ì—ì„œ JSON ë¡œë“œ"""
    path = _CONFIG_DIR / filename
    if path.exists():
        with open(path, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}


# ì£¼ì œ DB ìºì‹± (topics_expanded.json)
_TOPICS_CACHE: Optional[Dict] = None


def _get_topics_db() -> Dict:
    """topics_expanded.jsonì—ì„œ ì£¼ì œ ì •ë³´ ë¡œë“œ (ìºì‹±)"""
    global _TOPICS_CACHE
    if _TOPICS_CACHE is not None:
        return _TOPICS_CACHE

    data = _load_json("topics_expanded.json")
    topics_map = {}
    for category_key, category in data.get("categories", {}).items():
        for topic in category.get("topics", []):
            topics_map[topic["id"]] = {
                "ko": topic["ko"],
                "safety": topic["safety"],
                "note": topic.get("note", ""),
                "category": category_key,
            }
    _TOPICS_CACHE = topics_map
    return _TOPICS_CACHE


# í•´ì‹œíƒœê·¸ ì „ëµ ìºì‹±
_HASHTAG_CACHE: Optional[Dict] = None


def _get_hashtag_strategy() -> Dict:
    """hashtag_strategy.json ë¡œë“œ (ìºì‹±)"""
    global _HASHTAG_CACHE
    if _HASHTAG_CACHE is not None:
        return _HASHTAG_CACHE
    _HASHTAG_CACHE = _load_json("hashtag_strategy.json")
    return _HASHTAG_CACHE


# ì•ˆì „ë„ë³„ ì´ëª¨ì§€/ê¸‰ì—¬ ê°€ëŠ¥ ë§¤í•‘
_SAFETY_MAP = {
    "safe": {"emoji": "âœ…", "can_eat": "O", "label": "ê¸‰ì—¬ ê°€ëŠ¥!"},
    "caution": {"emoji": "âš ï¸", "can_eat": "â–³", "label": "ì£¼ì˜í•´ì„œ ê¸‰ì—¬"},
    "dangerous": {"emoji": "âŒ", "can_eat": "X", "label": "ì ˆëŒ€ ê¸ˆì§€!"},
}


class CaptionAgent(BaseAgent):
    """ìº¡ì…˜/ì¹´í”¼ ì „ë¬¸ ì—ì´ì „íŠ¸ (ì´ì¹´í”¼) - hashtag_strategy.json ì—°ë™"""

    @property
    def name(self) -> str:
        return "Caption"

    async def execute(self, input_data: Any) -> AgentResult:
        """ìº¡ì…˜ ìƒì„± ì‹¤í–‰"""
        if isinstance(input_data, str):
            topic = input_data
            safety = None
            topic_kr = None
        else:
            topic = input_data.get("topic", "unknown")
            safety = input_data.get("safety")
            topic_kr = input_data.get("topic_kr")

        self.log(f"'{topic}' ìº¡ì…˜ ìƒì„± ì‹œì‘")

        # ì£¼ì œ ì •ë³´ ì¡°íšŒ (topics_expanded.json)
        info = self._get_topic_info(topic, safety=safety, topic_kr=topic_kr)

        # ìº¡ì…˜ ìƒì„±
        caption = self._generate_caption(topic, info)

        # í•´ì‹œíƒœê·¸ ìƒì„± (hashtag_strategy.json)
        hashtags = self._generate_hashtags(topic, info)

        self.log(f"ìº¡ì…˜ ì™„ë£Œ (ë³¸ë¬¸ {len(caption)}ì, í•´ì‹œíƒœê·¸ {len(hashtags)}ê°œ)")

        # AI í‘œê¸° ë¬¸êµ¬ (2026-01-29 PD ì§€ì‹œ)
        ai_disclosure = "\n\nâ„¹ï¸ ì¼ë¶€ ì´ë¯¸ì§€ëŠ” AIë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\nâ„¹ï¸ Some images were generated by AI."

        return AgentResult(
            success=True,
            data={
                "topic": topic,
                "caption": {
                    "full": caption + "\n\n" + " ".join(hashtags) + ai_disclosure,
                    "body": caption,
                    "hashtags": hashtags,
                    "hashtag_count": len(hashtags),
                    "character_count": len(caption)
                },
                "topic_info": info
            },
            metadata={"agent": "leecopy", "hashtag_source": "hashtag_strategy.json"}
        )

    def _get_topic_info(self, topic: str, safety: Optional[str] = None, topic_kr: Optional[str] = None) -> Dict:
        """topics_expanded.jsonì—ì„œ ì£¼ì œ ì •ë³´ ì¡°íšŒ"""
        db = _get_topics_db()
        if topic in db:
            entry = db[topic]
            s = safety or entry["safety"]
            safety_info = _SAFETY_MAP.get(s, _SAFETY_MAP["safe"])
            return {
                "korean": topic_kr or entry["ko"],
                "safety": s,
                "can_eat": safety_info["can_eat"],
                "note": entry["note"],
                "category": entry["category"],
            }
        # DBì— ì—†ëŠ” ì£¼ì œ
        return {
            "korean": topic_kr or topic,
            "safety": safety or "unknown",
            "can_eat": "?",
            "note": "",
            "category": "unknown",
        }

    def _generate_caption(self, topic: str, info: Dict) -> str:
        """ìº¡ì…˜ ë³¸ë¬¸ ìƒì„± (Hook â†’ Answer â†’ Info â†’ CTA)"""
        korean = info["korean"]
        safety = info["safety"]
        can_eat = info["can_eat"]
        note = info["note"]

        safety_info = _SAFETY_MAP.get(safety, {"emoji": "ğŸ•", "label": "í™•ì¸ í•„ìš”"})

        if safety == "dangerous":
            verdict_detail = f"ê°•ì•„ì§€ì—ê²Œ {korean}ì€(ëŠ”) ìœ„í—˜í•´ìš”!"
        elif safety == "caution":
            verdict_detail = f"ê°•ì•„ì§€ {korean}, ì¡°ê±´ë¶€ë¡œ ê°€ëŠ¥í•´ìš”!"
        else:
            verdict_detail = f"ê°•ì•„ì§€ì—ê²Œ {korean} ì¤˜ë„ ë¼ìš”!"

        note_line = f"â€¢ ì°¸ê³ : {note}" if note else ""

        caption = f"""ê°•ì•„ì§€ì—ê²Œ {korean}ë¥¼(ì„) ì¤˜ë„ ë ê¹Œìš”?

{safety_info['emoji']} {safety_info['label']}
{verdict_detail}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

í•µì‹¬ ì •ë³´
â€¢ ê¸‰ì—¬ ê°€ëŠ¥: {can_eat}
{note_line}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ìŠ¤ì™€ì´í”„í•´ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”!
ì €ì¥í•´ë‘ê³  í•„ìš”í•  ë•Œ í™•ì¸í•˜ì„¸ìš”!

ë” ë§ì€ ê°•ì•„ì§€ ì •ë³´ â†’ í”„ë¡œí•„ ë§í¬"""

        return caption.strip()

    def _generate_hashtags(self, topic: str, info: Dict) -> List[str]:
        """
        hashtag_strategy.json ê¸°ë°˜ í•´ì‹œíƒœê·¸ ìƒì„±

        2026ë…„ Instagram ì•Œê³ ë¦¬ì¦˜ ìµœì í™”:
        - ìµœëŒ€ 5ê°œ í•´ì‹œíƒœê·¸
        - êµ¬ì„±: reach(1) + niche(1) + topic(1) + community(1) + brand(1)
        """
        strategy = _get_hashtag_strategy()
        korean = info.get("korean", topic)

        if not strategy:
            # fallback: ê¸°ë³¸ í•´ì‹œíƒœê·¸ 5ê°œ
            return [
                "#DogsOfInstagram",
                "#GoldenRetriever",
                f"#ê°•ì•„ì§€{korean}",
                "#í«ìŠ¤íƒ€ê·¸ë¨",
                "#í–‡ì‚´ì´"
            ]

        # 1. ì£¼ì œë³„ ì‚¬ì „ ì •ì˜ íƒœê·¸ í™•ì¸
        topics_tags = strategy.get("topics", {})
        if topic in topics_tags:
            predefined = topics_tags[topic].get("tags", [])
            if predefined:
                return predefined[:5]

        # 2. ë™ì  ìƒì„± (5ê°œ ìŠ¬ë¡¯)
        base_tags = strategy.get("base_tags", {})
        hashtags = []

        # ìŠ¬ë¡¯ 1: reach (ê¸€ë¡œë²Œ ëŒ€í˜•)
        reach_tags = base_tags.get("reach", [])
        if reach_tags:
            hashtags.append(random.choice(reach_tags))

        # ìŠ¬ë¡¯ 2: niche (í’ˆì¢…/íƒ€ê²Ÿ)
        niche_tags = base_tags.get("niche", [])
        if niche_tags:
            hashtags.append(random.choice(niche_tags))

        # ìŠ¬ë¡¯ 3: topic (ì£¼ì œ ê´€ë ¨ í•œê¸€)
        hashtags.append(f"#ê°•ì•„ì§€{korean}")

        # ìŠ¬ë¡¯ 4: community (ì»¤ë®¤ë‹ˆí‹°)
        community_tags = base_tags.get("community", [])
        if community_tags:
            hashtags.append(random.choice(community_tags))

        # ìŠ¬ë¡¯ 5: brand (ë¸Œëœë“œ)
        brand_tags = base_tags.get("brand", [])
        if brand_tags:
            hashtags.append(brand_tags[0])  # ì²« ë²ˆì§¸ ë¸Œëœë“œ íƒœê·¸ ê³ ì •

        # ì¤‘ë³µ ì œê±° ë° 5ê°œ ë³´ì¥
        result = list(dict.fromkeys(hashtags))[:5]

        # 5ê°œ ë¯¸ë§Œì¸ ê²½ìš° fallback ì¶”ê°€
        fallbacks = ["#ë°˜ë ¤ê²¬", "#ë©ìŠ¤íƒ€ê·¸ë¨", "#ê°•ì•„ì§€ê°„ì‹", "#í«ìŠ¤íƒ€ê·¸ë¨", "#í–‡ì‚´ì´"]
        for fb in fallbacks:
            if len(result) >= 5:
                break
            if fb not in result:
                result.append(fb)

        return result[:5]

    def generate_caption_for_topic(self, topic: str) -> str:
        """ê°„í¸ ìº¡ì…˜ ìƒì„± (ë™ê¸° ë²„ì „)"""
        info = self._get_topic_info(topic)
        caption = self._generate_caption(topic, info)
        hashtags = self._generate_hashtags(topic, info)
        return caption + "\n\n" + " ".join(hashtags)
