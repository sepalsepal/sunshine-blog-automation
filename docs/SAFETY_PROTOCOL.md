# Safety Protocol v0.2 (변경 안전 프로토콜)

> **버전:** v0.2 (Day 8 업데이트)
> **작성일:** 2026-01-31
> **기준 문서:** Project_Sunshine_Execution_Guidebook_v1.1.md
> **목적:** 코드/설정 변경 전 안전 검증

---

## 변경 전 5초 체크리스트 (v0.2)

> **모든 코드/설정 변경 전 반드시 확인**

```
□ 1. 영향 범위 3줄 이내인가?
□ 2. 동일 조건 3회 테스트 가능한가?
□ 3. 롤백 5분 이내 가능한가?
□ 4. docs/CHANGELOG.md에 기록했는가?
□ 5. Top3 사고 유형과 관련있는가?
□ 6. 캡션-이미지 안전 판정이 일치하는가? (v0.2 신규)

→ 6개 Yes: 변경 승인
→ 1개 No: 보류 후 검토
```

---

## 항목별 상세

### 1. 영향 범위 3줄 이내

```
✅ 좋은 예:
- 프롬프트 1줄 수정
- 색상값 1개 변경
- Agent 점수 기준 1개 조정

❌ 나쁜 예:
- 전체 AOC 구조 변경
- 5개 파일 동시 수정
- 새로운 Agent 추가
```

### 2. 동일 조건 3회 테스트

```
변경 후 동일 입력으로 3회 실행:
- 3회 모두 PASS → 변경 확정
- 1~2회 FAIL → 추가 검토
- 3회 FAIL → 즉시 롤백
```

### 3. 롤백 5분 이내

```
✅ 롤백 가능:
- git checkout으로 복구 가능
- 이전 버전 파일 백업 있음
- 설정값만 변경 (구조 변경 아님)

❌ 롤백 불가:
- 데이터베이스 스키마 변경
- 외부 API 키 변경
- 삭제된 파일 복구 불가
```

### 4. CHANGELOG 기록

```markdown
## [날짜] [시간]

### 변경 내용
- [파일명]: [변경 내용 1줄]

### 변경 이유
- [Failure Map Top3 연관 / PD 지시 / 버그 수정]

### 영향 범위
- [영향받는 Agent/파일]

### 롤백 방법
- [git checkout / 파일 복원 / 값 변경]
```

### 5. Top3 사고 유형 연관

```
Failure Map Top3:
1. 정보 오류 (독성 음식 등)
2. 포맷 위반 (글자 잘림, 비율)
3. 톤 붕괴 (너무 딱딱/가벼움)

변경이 Top3 해결에 도움되는가?
→ Yes: 우선순위 높음
→ No: 우선순위 낮음 (보류 권장)
```

### 6. 캡션-이미지 안전 판정 일치 (v0.2 신규)

> **배경:** Day 5~6 icecream, kitkat F2 발생 (캡션/이미지 불일치)

```
✅ 정상:
- SAFE 음식 → 캡션 "먹어도 돼요" + 이미지 "안전"
- DANGER 음식 → 캡션 "급여 금지" + 이미지 "위험"

❌ 불일치 (F2 FAIL):
- DANGER 음식 → 캡션 "먹어도 돼요" ← 금지!
- SAFE 음식 → 캡션 "급여 금지" ← 금지!

검증 방법:
1. 음식 안전 분류 확인 (SAFE/CAUTION/DANGER/FORBIDDEN)
2. 캡션 톤 확인 (긍정/부정)
3. 이미지 내 텍스트 확인
4. 3가지 모두 일치해야 PASS
```

---

## CLAUDE.md 변경 락

### 변경 조건

```
1. Failure Map Top3에 포함된 항목만 변경 가능
2. 주 1회 변경 제한
3. 한 항목당 1줄, 최대 3줄
```

### Top3 확정 규칙

```
최소 표본: 10개 콘텐츠
동일 유형 3회 이상 발생
전체 실패 중 비중 30% 이상
```

---

## 비용 가드레일

### 이미지 API

```
일일 상한: $3
초과 시: 자동 중단 + 다음 날 이월
텍스트 선검증: 텍스트 PASS 후에만 이미지 생성
```

### 월간 비용

```
목표: $50 이내
초과 예상 시: PD님 사전 승인 필수
```

---

## 병렬 안전장치

```
1. 텍스트 선검증: Agent B 60점 미만 → 이미지 생성 차단
2. 실패 자동 폐기: L3(재생성)+L4(폐기) 즉시 중단
3. 동시 최대 5개 Task
4. FAIL 3회 누적: 해당 에이전트 자동 중단 (F2 제외)
5. PD님 알림: 일일 게시 3개 이상 시 최종 확인
```

---

## 긴급 중단 조건

| 조건 | 동작 |
|------|------|
| L3+L4 사고 2회 연속 | 즉시 중단 + 롤백 |
| 비용 일일 상한 초과 | 자동 중단 |
| Agent D Red Flag 2개+ | 즉시 중단 |
| 동일 FAIL 3회 누적 | 해당 Agent 중단 |

---

## 회복점 (Recovery Point)

### Day 7 회복점

```
- FAIL 패턴 상위 3개 정리
- F2 (기준 충돌) 리뷰
- AOC v0.2 수정 여부 결정
- 무인 통과율 첫 측정
```

### Day 14 회복점

```
- FAIL 패턴 상위 5개 정리
- F2 누적 리뷰
- 수동 개입 Top2 지점 확인
- 2주 전체 데이터 종합
```

---

**마지막 업데이트:** 2026-01-31 (Day 8)
**버전:** v0.2
