# MCP Architecture

> 이 문서는 Project Sunshine의 설계 의도를 기록합니다.
> 미래의 수정자가 시스템을 망가뜨리지 않도록 하는 "락(Lock)" 역할입니다.

---

## 역할 분리 원칙

```
┌─────────────────────────────────────────────────────┐
│  PD (사람)      │  판단, 승인, 규칙 변경            │
├─────────────────────────────────────────────────────┤
│  MCP (시스템)   │  실행, 검증, 기록                 │
├─────────────────────────────────────────────────────┤
│  LLM           │  생성 도구일 뿐, 판단 주체 아님    │
└─────────────────────────────────────────────────────┘
```

### 왜 이렇게 분리했는가?

1. **LLM은 확률적** - "비슷해 보인다"는 매번 다른 답이 나올 수 있음
2. **사람만 책임질 수 있음** - 게시 후 문제 발생 시 판단 책임은 PD에게
3. **시스템은 규칙만 따름** - 감정, 추론, 예외 판단 없음

---

## 절대 금지 규칙 (4대 원칙)

### 1. 이미지 분석으로 PASS/FAIL 판단하지 않는다

```
❌ "이 표지가 규칙에 맞아 보이니까 PASS"
✅ "metadata.rule_name === 'cover_v1' 이므로 PASS"
```

### 2. "비슷해 보인다"는 판단 기준이 아니다

```
❌ "기준 이미지와 비슷하니까 OK"
✅ "rule_hash 일치하므로 OK"
```

### 3. 규칙이 있으면 추론하지 않고 비교한다

```
❌ "아마 이 색상이 SAFE 초록색일 거야"
✅ "safety_level === 'SAFE' → color_code === '#4CAF50'"
```

### 4. 규칙 위반 콘텐츠는 분석하지 않고 즉시 폐기한다

```
❌ "규칙 위반이지만 괜찮아 보이니까 일단 보관"
✅ "규칙 위반 → 즉시 삭제 → 재생성"
```

---

## 왜 메타데이터 검증인가?

### 이미지 기반 검증의 문제

```
[이미지] → [LLM 분석] → [판단]
              ↓
         확률적 결과 (오탐 필연)
```

- 같은 이미지도 물어볼 때마다 다른 답
- "95% 확신" = 20번 중 1번은 틀림
- 누적되면 반드시 사고 발생

### 메타데이터 기반 검증의 장점

```
[이미지 + 메타데이터] → [규칙 비교] → [PASS/FAIL]
                            ↓
                      결정적 결과 (100% 동일)
```

- 생성 경로를 검증하면 거짓 PASS가 구조적으로 불가능
- rule_hash가 다르면 무조건 FAIL
- 사람 감정, LLM 기분과 무관

---

## 상태 전이 모델

```
[생성 요청]
    ↓
[generated] ─── 규칙 기반 생성 완료
    ↓
[verified] ──── 메타데이터 검증 완료
    ↓
[approved] ──── PD 승인 완료 (사람 필수)
    ↓
[published] ─── Instagram 게시 완료
```

### 역방향 금지

- published → approved (X)
- approved → verified (X)
- 상태는 앞으로만 진행

---

## 핵심 설계 결정 기록

| 결정 | 이유 | 날짜 |
|------|------|------|
| 메타데이터 검증 채택 | LLM 이미지 분석 오탐 반복 | 2026-02-02 |
| PD 승인 필수화 | 자동 게시 사고 방지 | 2026-02-03 |
| rule_hash 도입 | 규칙 버전 불일치 감지 | 2026-02-02 |
| 폴더 정리 규칙 | 작업 파일 혼재 문제 | 2026-02-03 |

---

## 수정 시 주의사항

이 시스템을 수정하려는 미래의 당신에게:

1. **"더 똑똑하게" 하려 하지 마세요** - 단단한 게 낫습니다
2. **LLM 판단을 추가하려 하지 마세요** - 규칙 비교로 충분합니다
3. **예외를 만들려 하지 마세요** - 예외가 버그가 됩니다
4. **이 문서를 먼저 읽으세요** - 왜 이렇게 설계했는지 이해한 후 수정하세요

---

**작성:** 김부장 + 레드2
**승인:** 박세준 PD
**버전:** 1.0.0
**날짜:** 2026-02-03
